<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senior Swipe</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable manual dark mode
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>

    <script src="data.js"></script>

    <style>
        body {
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #52525b;
        }

        .card-enter {
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes slideOutLeft {
            to {
                transform: translateX(-50px);
                opacity: 0;
            }
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(50px);
                opacity: 0;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-50px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(50px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-pop {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-exit-left {
            animation: slideOutLeft 0.2s forwards;
        }

        .card-exit-right {
            animation: slideOutRight 0.2s forwards;
        }

        .card-enter-left {
            animation: slideInLeft 0.2s forwards;
        }

        .card-enter-right {
            animation: slideInRight 0.2s forwards;
        }

        /* Markdown Styles */
        .markdown-body strong {
            font-weight: 800;
            color: inherit;
        }

        .markdown-body em {
            font-style: italic;
            opacity: 0.8;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 0.5em;
        }

        .markdown-body li {
            margin-bottom: 0.25em;
        }

        .markdown-body p {
            margin-bottom: 0.75em;
        }

        /* Fix Code Overflow */
        .markdown-body pre {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            max-width: 100%;
        }

        .dark .markdown-body pre {
            background: #18181b;
            /* zinc-900 */
        }

        .markdown-body code {
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-word;
            /* Wrap long inline code */
        }

        .markdown-body pre code {
            word-break: normal;
            /* Don't wrap blocks, scroll instead */
            white-space: pre;
        }

        .markdown-body code:not([class*="language-"]) {
            background: rgba(100, 116, 139, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            color: #ef4444;
            font-size: 0.9em;
        }

        .dark .markdown-body code:not([class*="language-"]) {
            background: rgba(255, 255, 255, 0.1);
            color: #f87171;
        }

        .markdown-body pre {
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
            white-space: pre-wrap;
            /* Wrap code lines */
            word-break: break-all;
            /* Break long words if needed */
            max-width: 100%;
            /* Ensure it fits in card */
            padding: 1em;
            /* Add padding */
        }

        /* 3D Flip Utilities */
        .perspective-1000 {
            perspective: 1000px;
        }

        .preserve-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const SRS = { AGAIN: 0, HARD: 1, GOOD: 2, EASY: 3 };

        // --- COMPONENTS ---
        const HighlightText = ({ text, term }) => {
            if (!term || term.length < 2) return text;
            try {
                const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const parts = text.split(new RegExp(`(${escaped})`, 'gi'));
                return (
                    <span>
                        {parts.map((part, i) =>
                            part.toLowerCase() === term.toLowerCase() ? <mark key={i} className="bg-yellow-200 dark:bg-yellow-900/50 text-slate-800 dark:text-zinc-200 rounded-sm px-0.5">{part}</mark> : part
                        )}
                    </span>
                );
            } catch (e) { return text; }
        };

        const Markdown = ({ content, searchTerm }) => {
            useEffect(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, [content]);

            const processedContent = useMemo(() => {
                if (!content) return "";
                if (!searchTerm || searchTerm.length < 2) return content;

                // Escape special regex chars
                const escaped = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escaped})`, 'gi');
                // Use a standard mark tag with Tailwind class for dark mode text visibility
                return content.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-900/50 text-slate-800 dark:text-zinc-200 rounded-sm px-0.5">$1</mark>');
            }, [content, searchTerm]);

            return <div className="markdown-body text-sm leading-relaxed text-slate-600 dark:text-slate-300" dangerouslySetInnerHTML={{ __html: marked.parse(processedContent) }} />;
        };

        const Toast = ({ message }) => (
            <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-3 card-enter">
                <span className="text-green-500"><Icons.CheckCircle size={18} /></span>
                <span className="text-sm font-bold">{message}</span>
            </div>
        );

        const Icon = ({ path, size = 20, className = "", fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Heart: (p) => <Icon {...p} path={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Home: (p) => <Icon {...p} path={<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>} />,
            Bookmark: (p) => <Icon {...p} path={<path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" />} />,
            Moon: (p) => <Icon {...p} path={<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />,
            Alert: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>} />,
            EyeOff: (p) => <Icon {...p} path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></>} />,
            Globe: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10" /><path d="M2 12h20" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></>} />,
            Robot: (p) => <Icon {...p} path={<><rect width="18" height="12" x="3" y="6" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M12 6V3" /><path d="M8 6V4" /><path d="M16 6V4" /></>} />,
            Flame: (p) => <Icon {...p} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.07 1.5-2.2 2.5-3.2Z" />} />,
            Wrench: (p) => <Icon {...p} path={<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3" />} />,
            Trophy: (p) => <Icon {...p} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></>} />,
            Filter: (p) => <Icon {...p} path={<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />} />,
            Mic: (p) => <Icon {...p} path={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" x2="12" y1="19" y2="23" /><line x1="8" x2="16" y1="23" y2="23" /></>} />,
            Headphones: (p) => <Icon {...p} path={<><path d="M3 18v-6a9 9 0 0 1 18 0v6" /><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z" /></>} />,
            Stop: (p) => <Icon {...p} path={<rect x="6" y="6" width="12" height="12" rx="2" />} />,
            Edit: (p) => <Icon {...p} path={<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />} />,
            ChevronDown: (p) => <Icon {...p} path={<path d="m6 9 6 6 6-6" />} />,
            Book: (p) => <Icon {...p} path={<><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></>} />,
            Trash: (p) => <Icon {...p} path={<><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>} />,
            Filter: (p) => <Icon {...p} path={<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12" />} />,
            RotateCcw: (p) => <Icon {...p} path={<><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></>} />,
        };

        const SimpleConfetti = () => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                let particles = [];
                const colors = ['#6366f1', '#a855f7', '#ec4899', '#22c55e', '#eab308'];

                for (let i = 0; i < 150; i++) {
                    particles.push({
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 20,
                        vy: (Math.random() - 0.5) * 20,
                        life: 100 + Math.random() * 50,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: Math.random() * 5 + 2
                    });
                }

                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach((p, index) => {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // Gravity
                        p.life--;
                        p.size *= 0.99;

                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();

                        if (p.life <= 0) particles.splice(index, 1);
                    });
                    if (particles.length > 0) requestAnimationFrame(animate);
                };
                animate();
            }, []);
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-pop border border-slate-100 dark:border-zinc-800" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-2">Are you sure?</h3>
                        <p className="text-sm text-slate-500 dark:text-zinc-400 mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-300 hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors">Cancel</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 transition-colors">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SessionSetupModal = ({ isOpen, onClose, categories, onStart, totalCards }) => {
            if (!isOpen) return null;
            const [mode, setMode] = useState('smart'); // smart, sequential
            const [range, setRange] = useState({ limit: 15 });

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-pop">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">Session Setup</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">Close</button>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Sorting Strategy</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => setMode('smart')} className={`p-3 rounded-xl border text-sm font-bold transition-all ${mode === 'smart' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-200 dark:border-zinc-800 text-slate-600 dark:text-zinc-400'}`}>
                                        âš¡ Smart Shuffle
                                    </button>
                                    <button onClick={() => setMode('sequential')} className={`p-3 rounded-xl border text-sm font-bold transition-all ${mode === 'sequential' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-200 dark:border-zinc-800 text-slate-600 dark:text-zinc-400'}`}>
                                        ðŸ”¢ Sequential
                                    </button>
                                </div>
                                <p className="text-[10px] text-slate-400 mt-2">
                                    {mode === 'smart' ? 'Prioritizes new cards and mistakes. Best for learning.' : 'Orders questions by ID (e.g. 1001, 1002). Best for systematic review.'}
                                </p>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Number of Questions</label>
                                <input type="number" value={range.limit} onChange={e => setRange({ ...range, limit: parseInt(e.target.value) })} className="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg p-3 text-center font-mono font-bold" placeholder="e.g. 15" />
                                <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                                    <span>Selected: {totalCards}</span>
                                    <span>Default: 15</span>
                                </div>
                            </div>

                            <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-zinc-800 rounded-xl">
                                <span className="text-sm font-bold text-slate-700 dark:text-zinc-300">Due Reviews Only</span>
                                <button
                                    onClick={() => setRange(prev => ({ ...prev, dueOnly: !prev.dueOnly }))}
                                    className={`w-12 h-6 rounded-full p-1 transition-colors ${range.dueOnly ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-700'}`}
                                >
                                    <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${range.dueOnly ? 'translate-x-6' : 'translate-x-0'}`} />
                                </button>
                            </div>

                            <button onClick={() => onStart(mode, range)} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-indigo-500/30 transition-all active:scale-95">
                                Launch Session ðŸš€
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LevelRoadmapModal = ({ isOpen, onClose, currentXp, currentLevel }) => {
            if (!isOpen) return null;
            // Generate levels 1-50
            const levels = [];
            for (let i = 1; i <= 50; i++) {
                // Formula: Math.sqrt(xp / 25) + 1 = level  =>  (level-1)^2 * 25 = xp
                const minXp = Math.pow(i - 1, 2) * 25;
                let title = "Intern";
                if (i >= 5) title = "Junior Dev";
                if (i >= 15) title = "Mid-Level Dev";
                if (i >= 30) title = "Senior Dev";
                if (i >= 40) title = "Staff Engineer";
                if (i >= 50) title = "Principal Architect";
                levels.push({ level: i, minXp, title });
            }

            const getProgress = (lvl) => {
                if (currentLevel > lvl.level) return 100;
                if (currentLevel < lvl.level) return 0;
                // Current level progress
                const nextLvlXp = Math.pow(lvl.level, 2) * 25;
                const prevLvlXp = Math.pow(lvl.level - 1, 2) * 25;
                return Math.min(100, Math.max(0, ((currentXp - prevLvlXp) / (nextLvlXp - prevLvlXp)) * 100));
            };


            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center bg-slate-50 dark:bg-zinc-800/50">
                            <h2 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icons.Trophy className="text-yellow-500" /> Career Roadmap</h2>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-700 text-slate-400"><Icons.X size={18} /></button>
                        </div>
                        <div className="overflow-y-auto p-4 space-y-3">
                            {levels.map(l => (
                                <div key={l.level} className={`flex items-center gap-3 p-3 rounded-xl border ${l.level === currentLevel ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : l.level < currentLevel ? 'border-indigo-100 bg-white dark:bg-zinc-900 dark:border-zinc-800' : 'border-slate-100 dark:border-zinc-800 opacity-60'}`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${l.level <= currentLevel ? 'bg-indigo-600 text-white' : 'bg-slate-200 dark:bg-zinc-700 text-slate-500'}`}>{l.level}</div>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className={`font-bold text-xs ${l.level === currentLevel ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-700 dark:text-slate-300'}`}>{l.title}</span>
                                            <span className="text-[10px] font-mono text-slate-400">{l.minXp} XP</span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-zinc-700 h-1.5 rounded-full overflow-hidden">
                                            <div className="h-full bg-indigo-500 transition-all" style={{ width: `${getProgress(l)}%` }}></div>
                                        </div>
                                    </div>
                                    {l.level === currentLevel && <Icons.Wrench size={14} className="text-indigo-500 animate-spin-slow" />}
                                    {l.level < currentLevel && <Icons.CheckCircle size={14} className="text-indigo-400" />}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CardCreatorView = ({ onClose, onSave, categories, initialData = null }) => {
            const [form, setForm] = useState(initialData || { title: '', category: categories[0] || 'General', difficulty: 'Senior', content: '', explanation: '' });
            const [viewMode, setViewMode] = useState('write'); // write, preview

            const handleSubmit = () => {
                if (!form.title || !form.content) return alert("Title and Content are required.");
                const card = {
                    ...form,
                    id: initialData ? initialData.id : Date.now(), // Preserve ID if editing
                    timestamp: Date.now()
                };
                onSave(card);
            };

            return (
                <div className="fixed inset-0 z-50 flex justify-center items-end sm:items-center bg-black/50 backdrop-blur-sm animate-pop">
                    <div className="w-full max-w-md h-full sm:h-[90vh] bg-white dark:bg-zinc-950 flex flex-col shadow-2xl overflow-hidden sm:rounded-2xl">
                        <div className="p-4 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center">
                            <button onClick={onClose} className="text-slate-500 font-bold">Cancel</button>
                            <div className="flex bg-slate-100 dark:bg-zinc-800 rounded-lg p-1">
                                <button onClick={() => setViewMode('write')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${viewMode === 'write' ? 'bg-white dark:bg-zinc-700 shadow-sm text-indigo-600' : 'text-slate-400'}`}>Write</button>
                                <button onClick={() => setViewMode('preview')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${viewMode === 'preview' ? 'bg-white dark:bg-zinc-700 shadow-sm text-indigo-600' : 'text-slate-400'}`}>Preview</button>
                            </div>
                            <button onClick={handleSubmit} className="text-indigo-600 font-bold">Save</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {viewMode === 'write' ? (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Title</label>
                                        <input type="text" className="w-full p-3 bg-slate-50 dark:bg-zinc-900 rounded-xl" placeholder="e.g. Rate Limiting" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Category</label>
                                            <select className="w-full p-3 bg-slate-50 dark:bg-zinc-900 rounded-xl" value={form.category} onChange={e => setForm({ ...form, category: e.target.value })}>
                                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                                <option value="User Added">User Added</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Difficulty</label>
                                            <select className="w-full p-3 bg-slate-50 dark:bg-zinc-900 rounded-xl" value={form.difficulty} onChange={e => setForm({ ...form, difficulty: e.target.value })}>
                                                <option value="Junior">Junior</option>
                                                <option value="Senior">Senior</option>
                                                <option value="Principal">Principal</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Question (Markdown)</label>
                                        <textarea className="w-full p-3 bg-slate-50 dark:bg-zinc-900 rounded-xl h-32 font-mono text-sm" placeholder="# Question..." value={form.content} onChange={e => setForm({ ...form, content: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Explanation (Markdown)</label>
                                        <textarea className="w-full p-3 bg-slate-50 dark:bg-zinc-900 rounded-xl h-32 font-mono text-sm" placeholder="The answer is..." value={form.explanation} onChange={e => setForm({ ...form, explanation: e.target.value })} />
                                    </div>
                                </>
                            ) : (
                                <div className="space-y-6">
                                    <div className="bg-white dark:bg-zinc-900 rounded-3xl shadow-xl border border-slate-200 dark:border-zinc-800 p-6">
                                        <span className="text-[10px] px-2 py-1 rounded-full font-bold tracking-wider uppercase bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300 mr-2">{form.category}</span>
                                        <span className="text-[10px] px-2 py-1 rounded-full font-bold tracking-wider uppercase bg-slate-100 text-slate-500">{form.difficulty}</span>
                                        <h3 className="text-xl font-bold text-slate-800 dark:text-white mt-3">{form.title}</h3>
                                        <div className="mt-6 border-t border-slate-100 dark:border-zinc-800 pt-6">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-4">Question</label>
                                            <Markdown content={form.content} />
                                        </div>
                                        <div className="mt-6 border-t border-slate-100 dark:border-zinc-800 pt-6">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-4">Answer</label>
                                            <Markdown content={form.explanation} />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- AUDIO DB HELPER ---
        const AudioDB = {
            dbName: 'SeniorSwipeAudio',
            version: 1,
            init: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(AudioDB.dbName, AudioDB.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('recordings')) {
                            db.createObjectStore('recordings', { keyPath: 'cardId' });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            save: async (cardId, blob) => {
                const db = await AudioDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('recordings', 'readwrite');
                    tx.objectStore('recordings').put({ cardId, blob, date: new Date() });
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            get: async (cardId) => {
                const db = await AudioDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('recordings', 'readonly');
                    const req = tx.objectStore('recordings').get(cardId);
                    req.onsuccess = () => resolve(req.result ? req.result.blob : null);
                    req.onerror = () => reject(req.error);
                });
            },
            getAll: async () => {
                const db = await AudioDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('recordings', 'readonly');
                    const req = tx.objectStore('recordings').getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            getKeys: async () => {
                const db = await AudioDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('recordings', 'readonly');
                    const req = tx.objectStore('recordings').getAllKeys();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            delete: async (cardId) => {
                const db = await AudioDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('recordings', 'readwrite');
                    tx.objectStore('recordings').delete(cardId);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        };


        const CustomCardDB = {
            dbName: 'SeniorSwipeCards',
            version: 1,
            init: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CustomCardDB.dbName, CustomCardDB.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('cards')) {
                            db.createObjectStore('cards', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            save: async (card) => {
                const db = await CustomCardDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('cards', 'readwrite');
                    tx.objectStore('cards').put(card);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            getAll: async () => {
                const db = await CustomCardDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('cards', 'readonly');
                    const req = tx.objectStore('cards').getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            delete: async (id) => {
                const db = await CustomCardDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('cards', 'readwrite');
                    tx.objectStore('cards').delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        };

        const AudioPlayer = ({ cardId }) => {
            const [src, setSrc] = useState(null);
            useEffect(() => {
                AudioDB.get(cardId).then(blob => {
                    if (blob) setSrc(URL.createObjectURL(blob));
                });
            }, [cardId]);

            if (!src) return null;

            return (
                <div className="mt-3 bg-slate-50 dark:bg-zinc-800 rounded-lg p-2 border border-slate-200 dark:border-zinc-700">
                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Voice Recording</div>
                    <audio controls src={src} className="w-full h-8" />
                </div>
            );
        };



        const NotesView = ({ cards, notes, onNav }) => {
            const [expandedContext, setExpandedContext] = useState([]);

            const notesList = Object.entries(notes).map(([id, content]) => {
                const card = cards.find(c => String(c.id) === String(id));
                return { id, content, card };
            }).filter(n => n.card);

            const toggleContext = (id) => {
                if (expandedContext.includes(id)) setExpandedContext(expandedContext.filter(i => i !== id));
                else setExpandedContext([...expandedContext, id]);
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 dark:bg-zinc-950">
                    <div className="p-4 bg-white dark:bg-zinc-950 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><Icons.Book className="text-indigo-500" /> My Notebook</h2>
                        <button onClick={() => onNav('home')} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-zinc-800 text-slate-400"><Icons.X /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {notesList.length === 0 && <div className="text-center text-slate-400 mt-20">No notes yet. Add notes via the Microphone/Edit button in Play Mode!</div>}
                        {notesList.map(n => (
                            <div key={n.id} className="bg-white dark:bg-zinc-900 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-zinc-800">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-bold text-slate-700 dark:text-zinc-300">{n.card.title}</h3>
                                    <button onClick={() => toggleContext(n.id)} className="text-[10px] font-bold uppercase tracking-wider text-indigo-500 hover:text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded transition-colors">
                                        {expandedContext.includes(n.id) ? 'Hide Context' : 'Show Context'}
                                    </button>
                                </div>
                                <div className="bg-yellow-50 dark:bg-yellow-900/10 p-3 rounded-lg text-sm text-slate-600 dark:text-yellow-100/80 mb-3 whitespace-pre-wrap">{n.content}</div>

                                {expandedContext.includes(n.id) && (
                                    <div className="mt-4 pt-4 border-t border-slate-100 dark:border-zinc-800 space-y-4">
                                        <div>
                                            <div className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-1">Question</div>
                                            <div className="text-xs text-slate-600 dark:text-zinc-400"><Markdown content={n.card.content} /></div>
                                        </div>
                                        <div>
                                            <div className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-1">Answer</div>
                                            <div className="text-xs text-slate-600 dark:text-zinc-400"><Markdown content={n.card.explanation} /></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const VoiceSelect = ({ voices, currentVoice, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                if (isOpen) {
                    document.addEventListener('click', handleClickOutside, true);
                }
                return () => {
                    document.removeEventListener('click', handleClickOutside, true);
                };
            }, [isOpen]);

            const filtered = voices.filter(v => v.name.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="relative" ref={containerRef}>
                    {/* Trigger */}
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 rounded-xl flex justify-between items-center border border-transparent focus:border-indigo-500 hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors"
                    >
                        <span className="truncate text-sm font-bold text-slate-700 dark:text-zinc-300 mr-2 text-left">
                            {currentVoice || "Default Browser Voice"}
                        </span>
                        <Icons.ChevronDown className={`text-slate-400 transition-transform duration-200 shrink-0 ${isOpen ? 'rotate-180' : ''}`} size={16} />
                    </button>

                    {/* Dropdown */}
                    {isOpen && (
                        <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-slate-100 dark:border-zinc-800 z-20 overflow-hidden flex flex-col max-h-60 animate-in fade-in zoom-in-95 duration-100">
                            <div className="p-2 border-b border-slate-100 dark:border-zinc-800 bg-slate-50/50 dark:bg-zinc-800/50">
                                <input
                                    autoFocus
                                    type="text"
                                    className="w-full p-2 bg-white dark:bg-zinc-900 rounded-lg text-xs border border-slate-200 dark:border-zinc-700 focus:outline-none focus:border-indigo-500"
                                    placeholder="Search voice..."
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                // Removed stopPropagation to ensure clicks register if needed, but input clicks are inside ref so safe
                                />
                            </div>
                            <div className="overflow-y-auto flex-1 p-1">
                                <div
                                    onClick={() => { onChange(""); setIsOpen(false); }}
                                    className={`p-2 rounded-lg text-xs mb-1 cursor-pointer flex items-center justify-between ${currentVoice === "" ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 font-bold' : 'text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800'}`}
                                >
                                    <span>Default Browser Voice</span>
                                    {currentVoice === "" && <Icons.CheckCircle size={12} />}
                                </div>
                                {filtered.map(v => (
                                    <div
                                        key={v.name}
                                        onClick={() => { onChange(v.name); setIsOpen(false); }}
                                        className={`p-2 rounded-lg text-xs mb-1 cursor-pointer flex items-center justify-between ${currentVoice === v.name ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 font-bold' : 'text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800'}`}
                                    >
                                        <span className="truncate mr-2">{v.name}</span>
                                        <span className="text-[9px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-zinc-800 text-slate-400">{v.lang}</span>
                                    </div>
                                ))}
                                {filtered.length === 0 && <div className="p-4 text-center text-xs text-slate-400">No voices found</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CustomSelect = ({ value, options, onChange, className = "" }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);
            const selectedOption = options.find(o => o.value === value) || options[0];

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                if (isOpen) {
                    document.addEventListener('click', handleClickOutside, true);
                }
                return () => {
                    document.removeEventListener('click', handleClickOutside, true);
                };
            }, [isOpen]);

            return (
                <div className={`relative ${className}`} ref={containerRef}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full h-full p-2 bg-slate-50 dark:bg-zinc-800 rounded-lg flex justify-between items-center border border-transparent focus:border-indigo-500 hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors"
                    >
                        <span className="text-sm font-bold text-slate-700 dark:text-zinc-300 text-left truncate mr-1">
                            {selectedOption?.label || value}
                        </span>
                        <Icons.ChevronDown className={`text-slate-400 transition-transform duration-200 shrink-0 ${isOpen ? 'rotate-180' : ''}`} size={14} />
                    </button>

                    {isOpen && (
                        <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-slate-100 dark:border-zinc-800 z-20 overflow-hidden animate-in fade-in zoom-in-95 duration-100 min-w-[80px]">
                            <div className="p-1">
                                {options.map(opt => (
                                    <div
                                        key={opt.value}
                                        onClick={() => { onChange(opt.value); setIsOpen(false); }}
                                        className={`p-2 rounded-lg text-xs mb-1 cursor-pointer flex items-center justify-between ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 font-bold' : 'text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800'}`}
                                    >
                                        <span>{opt.label}</span>
                                        {value === opt.value && <Icons.CheckCircle size={10} />}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TimePicker = ({ value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            // value is "HH:MM" 24h
            const [hours, minutes] = value ? value.split(':').map(Number) : [9, 0];
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = String(minutes).padStart(2, '0');

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false);
                };
                if (isOpen) document.addEventListener('click', handleClickOutside, true);
                return () => document.removeEventListener('click', handleClickOutside, true);
            }, [isOpen]);

            // Ensure scroll into view when opened
            useEffect(() => {
                if (isOpen && containerRef.current) {
                    const activeBtns = containerRef.current.querySelectorAll('.bg-indigo-600');
                    activeBtns.forEach(btn => btn.scrollIntoView({ block: 'center' }));
                }
            }, [isOpen]);

            const updateTime = (h, m, ap) => {
                let newH = h;
                if (ap === 'PM' && h < 12) newH += 12;
                if (ap === 'AM' && h === 12) newH = 0;
                onChange(`${String(newH).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
            };

            return (
                <div className="relative" ref={containerRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 px-3 py-2 bg-slate-50 dark:bg-zinc-800 rounded-lg border border-transparent focus:border-indigo-500 transition-all hover:bg-slate-100 dark:hover:bg-zinc-700">
                        <span className="text-lg font-bold font-mono text-slate-700 dark:text-white">
                            {String(displayHours).padStart(2, '0')}<span className="mx-0.5 opacity-50">:</span>{displayMinutes}
                        </span>
                        <span className="text-[10px] font-bold text-slate-500 dark:text-zinc-400 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 px-1.5 py-0.5 rounded uppercase">{ampm}</span>
                    </button>

                    {isOpen && (
                        <div className="absolute top-full left-0 mt-2 bg-white dark:bg-zinc-900 rounded-xl shadow-2xl border border-slate-100 dark:border-zinc-800 z-50 p-1 flex gap-1 animate-in fade-in zoom-in-95 duration-100 select-none">
                            {/* Hours */}
                            <div className="h-48 overflow-y-auto w-12 flex flex-col gap-1 text-center scrollbar-hide">
                                {[12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].map(h => (
                                    <button key={h} onClick={() => updateTime(h, minutes, ampm)} className={`p-2 rounded hover:bg-slate-100 dark:hover:bg-zinc-800 text-sm font-bold transition-colors ${h === displayHours ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'text-slate-600 dark:text-zinc-400'}`}>{String(h).padStart(2, '0')}</button>
                                ))}
                            </div>
                            {/* Min */}
                            <div className="h-48 overflow-y-auto w-12 flex flex-col gap-1 text-center border-l border-slate-100 dark:border-zinc-800 pl-1 scrollbar-hide">
                                {Array.from({ length: 60 }, (_, i) => i).map(m => (
                                    <button key={m} onClick={() => updateTime(displayHours, m, ampm)} className={`p-2 rounded hover:bg-slate-100 dark:hover:bg-zinc-800 text-sm font-bold transition-colors ${m === minutes ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'text-slate-600 dark:text-zinc-400'}`}>{String(m).padStart(2, '0')}</button>
                                ))}
                            </div>
                            {/* AM/PM */}
                            <div className="flex flex-col gap-1 border-l border-slate-100 dark:border-zinc-800 pl-1">
                                {['AM', 'PM'].map(ap => (
                                    <button key={ap} onClick={() => updateTime(displayHours, minutes, ap)} className={`p-2 rounded hover:bg-slate-100 dark:hover:bg-zinc-800 text-xs font-bold transition-colors ${ap === ampm ? 'bg-orange-500 text-white' : 'text-slate-600 dark:text-zinc-400'}`}>{ap}</button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirm", confirmColor = "bg-indigo-600", cancelText = "Cancel" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200 backdrop-blur-sm" onClick={onCancel}>
                    <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in-95 duration-200 border border-slate-100 dark:border-zinc-800" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-2">{title}</h3>
                        <p className="text-sm text-slate-600 dark:text-zinc-400 mb-6 leading-relaxed whitespace-pre-line">{message}</p>
                        <div className="flex gap-3">
                            {onCancel && <button onClick={onCancel} className="flex-1 py-3 rounded-xl font-bold text-slate-600 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-800 transition-colors">{cancelText}</button>}
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg shadow-indigo-500/20 transition-transform active:scale-95 ${confirmColor}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, onExport, onImport, useAIStudio, onToggleAIStudio, voices, currentVoice, onVoiceChange, srsSettings, onSrsChange, autoResume, onToggleAutoResume, notificationSettings, onNotificationChange, onReset }) => {
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            useEffect(() => {
                if (isOpen) document.body.style.overflow = 'hidden';
                return () => document.body.style.overflow = 'unset';
            }, [isOpen]);

            if (!isOpen) return null;

            const srsLabels = { hard: 'Hard (Left)', good: 'Good', easy: 'Easy (Right)' };

            const toggleNotifications = () => {
                if (!notificationSettings.enabled) {
                    if (Notification.permission !== 'granted') {
                        Notification.requestPermission().then(p => {
                            if (p === 'granted') onNotificationChange({ ...notificationSettings, enabled: true });
                            else alert("Notifications blocked. Please enable them in your browser settings.");
                        });
                    } else {
                        onNotificationChange({ ...notificationSettings, enabled: true });
                    }
                } else {
                    onNotificationChange({ ...notificationSettings, enabled: false });
                }
            };

            const testNotification = () => {
                const msg = "This is a test notification! ðŸ””";
                if (Notification.permission === 'granted') {
                    new Notification("Senior Swipe", { body: msg });
                } else {
                    Notification.requestPermission().then(p => {
                        if (p === 'granted') new Notification("Senior Swipe", { body: msg });
                        else alert("Permission denied. Check browser settings.");
                    });
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white dark:bg-zinc-900 w-full max-w-sm rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="p-6 border-b border-slate-100 dark:border-zinc-800 shrink-0">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">Settings</h3>
                        </div>

                        {/* Scrollable Body */}
                        <div className="p-6 overflow-y-auto flex-1 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Preferences</label>
                                <div className="space-y-2">
                                    <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-zinc-800 rounded-xl">
                                        <span className="text-sm font-bold text-slate-700 dark:text-zinc-300">Resume Recent Session</span>
                                        <button
                                            onClick={onToggleAutoResume}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors ${autoResume ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-700'}`}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${autoResume ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                    <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-zinc-800 rounded-xl">
                                        <span className="text-sm font-bold text-slate-700 dark:text-zinc-300">Ask AI opens AI Studio</span>
                                        <button
                                            onClick={onToggleAIStudio}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors ${useAIStudio ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-700'}`}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${useAIStudio ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Notifications</label>
                                <div className="p-4 bg-slate-50 dark:bg-zinc-800 rounded-xl space-y-4">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <Icons.Alert size={16} className="text-slate-400" />
                                            <div className="flex flex-col">
                                                <span className="text-sm font-bold text-slate-700 dark:text-zinc-300">Daily Reminders</span>
                                                <span className="text-[10px] text-slate-400 font-medium flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-orange-400 animate-pulse"></span> Requires open tab</span>
                                            </div>
                                        </div>
                                        <button
                                            onClick={toggleNotifications}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors ${notificationSettings.enabled ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-700'}`}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${notificationSettings.enabled ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>

                                    {notificationSettings && notificationSettings.enabled && (
                                        <div className="space-y-4 pt-2 border-t border-slate-100 dark:border-zinc-700 animate-in slide-in-from-top-2">
                                            <div>
                                                <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">Schedule Days</div>
                                                <div className="flex justify-between bg-white dark:bg-zinc-900 p-2 rounded-xl border border-slate-100 dark:border-zinc-800">
                                                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                                                        <button
                                                            key={i}
                                                            onClick={() => {
                                                                const newDays = notificationSettings.days.includes(i) ? notificationSettings.days.filter(x => x !== i) : [...notificationSettings.days, i];
                                                                onNotificationChange({ ...notificationSettings, days: newDays });
                                                            }}
                                                            className={`w-8 h-8 rounded-lg text-xs font-bold transition-all ${notificationSettings.days.includes(i) ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-zinc-800'}`}
                                                        >
                                                            {d}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="text-[10px] font-bold text-slate-400 uppercase">Alert Times</div>
                                                    <div className="flex gap-2">
                                                        <button className="text-[10px] bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 px-2 py-1 rounded-lg font-bold hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors" onClick={testNotification}>Test ðŸ””</button>
                                                        <button className="text-[10px] bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-lg font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors" onClick={() => onNotificationChange({ ...notificationSettings, times: [...notificationSettings.times, "09:00"] })}>+ Add Time</button>
                                                    </div>
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    {notificationSettings.times.map((t, i) => (
                                                        <div key={i} className="flex items-center gap-2 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl p-1 pr-2 shadow-sm">
                                                            <TimePicker
                                                                value={t}
                                                                onChange={val => {
                                                                    const newTimes = [...notificationSettings.times];
                                                                    newTimes[i] = val;
                                                                    onNotificationChange({ ...notificationSettings, times: newTimes });
                                                                }}
                                                            />
                                                            <button onClick={() => onNotificationChange({ ...notificationSettings, times: notificationSettings.times.filter((_, idx) => idx !== i) })} className="text-slate-400 hover:text-red-500 transition-colors bg-slate-100 dark:bg-zinc-800 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded-lg"><Icons.X size={14} /></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Text-to-Speech Voice</label>
                                <VoiceSelect
                                    voices={voices}
                                    currentVoice={currentVoice}
                                    onChange={onVoiceChange}
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">SRS Intervals</label>
                                <div className="space-y-3">
                                    {['hard', 'good', 'easy'].map(key => (
                                        <div key={key} className="flex items-center gap-2">
                                            <span className={`w-20 text-[10px] font-bold uppercase ${key === 'hard' ? 'text-orange-500' : key === 'good' ? 'text-green-500' : 'text-blue-500'}`}>{srsLabels[key]}</span>
                                            <input
                                                type="number"
                                                step="0.1"
                                                value={srsSettings[key]?.val ?? srsSettings[key]}
                                                onChange={e => onSrsChange(key, 'val', parseFloat(e.target.value))}
                                                className="flex-1 p-2 bg-slate-50 dark:bg-zinc-800 rounded-lg text-sm font-bold text-slate-700 dark:text-zinc-300 outline-none"
                                            />

                                            <CustomSelect
                                                value={srsSettings[key]?.unit || 'd'}
                                                options={[
                                                    { value: 'm', label: 'Min' },
                                                    { value: 'h', label: 'Hour' },
                                                    { value: 'd', label: 'Day' }
                                                ]}
                                                onChange={val => onSrsChange(key, 'unit', val)}
                                                className="w-24"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="pt-4 border-t border-slate-100 dark:border-zinc-800">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Data Management</label>
                                <div className="flex gap-2">
                                    <button onClick={onExport} className="flex-1 p-3 bg-slate-100 dark:bg-zinc-800 rounded-xl text-sm font-bold text-slate-600 dark:text-zinc-300 hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors">Backup</button>
                                    <label className="flex-1 cursor-pointer p-3 bg-indigo-600 rounded-xl text-sm font-bold text-white text-center hover:bg-indigo-700 transition-colors">
                                        Restore
                                        <input type="file" className="hidden" accept=".json" onChange={onImport} />
                                    </label>
                                </div>
                                <button onClick={() => setShowResetConfirm(true)} className="w-full mt-3 p-3 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl text-sm font-bold hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors border border-transparent hover:border-red-200 dark:hover:border-red-900/50">Reset App Data</button>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-6 border-t border-slate-100 dark:border-zinc-800 shrink-0 bg-white dark:bg-zinc-900">
                            <button onClick={onClose} className="w-full py-3 bg-slate-100 dark:bg-zinc-800 rounded-xl text-slate-600 dark:text-zinc-300 font-bold hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors">Close</button>
                        </div>

                        <ConfirmDialog
                            isOpen={showResetConfirm}
                            title="Reset Application?"
                            message={"This will delete ALL progress, cards, streaks, and settings.\n\nThis action cannot be undone."}
                            onConfirm={() => { setShowResetConfirm(false); onReset(); }}
                            onCancel={() => setShowResetConfirm(false)}
                            confirmText="Reset Everything"
                            confirmColor="bg-red-500 hover:bg-red-600"
                        />
                    </div>
                </div>
            );
        };

        const RadarChart = ({ data, size = 200 }) => {
            const center = size / 2;
            const radius = (size / 2) - 20;
            const angleSlice = (Math.PI * 2) / data.length;

            // Coordinates
            const points = data.map((d, i) => {
                const r = (d.value / 100) * radius;
                const angle = i * angleSlice - Math.PI / 2;
                return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
            }).join(' ');

            // Axis lines
            const axes = data.map((d, i) => {
                const angle = i * angleSlice - Math.PI / 2;
                return (
                    <line key={i} x1={center} y1={center} x2={center + radius * Math.cos(angle)} y2={center + radius * Math.sin(angle)} stroke="currentColor" strokeOpacity="0.2" />
                );
            });

            // Labels
            const labels = data.map((d, i) => {
                const angle = i * angleSlice - Math.PI / 2;
                const r = radius + 15;
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                return (
                    <text key={i} x={x} y={y} fontSize="9" textAnchor="middle" alignmentBaseline="middle" fill="currentColor" className="uppercase font-bold tracking-wider opacity-60">
                        {d.label}
                    </text>
                );
            });

            return (
                <svg width={size} height={size} className="text-slate-400 dark:text-zinc-500">
                    <circle cx={center} cy={center} r={radius} fill="none" stroke="currentColor" strokeOpacity="0.1" />
                    <circle cx={center} cy={center} r={radius * 0.5} fill="none" stroke="currentColor" strokeOpacity="0.1" />
                    {axes}
                    <polygon points={points} fill="rgba(99, 102, 241, 0.2)" stroke="#6366f1" strokeWidth="2" />
                    {labels}
                </svg>
            );
        };

        const NOTIFICATION_TEMPLATES = [
            "Time to code! ðŸ’»", "Don't break the streak! ðŸ”¥", "Senior Dev salary is waiting... ðŸ’°", "One card closer to mastery ðŸš€",
            "Your future self will thank you ðŸ™", "Code is temporary, knowledge is power ðŸ§ ", "Review time! â°", "Level up your skills â¬†ï¸",
            "Interview coming up? ðŸŽ¤", "Just 5 minutes? â³", "A senior dev reviews daily ðŸ“…", "Stay sharp! ðŸ”ª", "Cracking the coding interview? ðŸ“–",
            "Git commit -m 'progress' ðŸ’¾", "Console.log('success') âœ…", "404: Excuses not found ðŸš«", "200: OK to study ðŸ‘Œ", "While (alive) { study(); } ðŸ”„",
            "Refactor your brain ðŸ§ ", "Optimization time âš¡", "Don't let your skills rot ðŸ§Ÿ", "Consistency is key ðŸ”‘", "Building the dream ðŸ—ï¸",
            "Debug your knowledge ðŸž", "System Design awaits ðŸ“", "Algorithm practice time ðŸ§®", "Data Structures? Yes please. ðŸ“Š",
            "Big O(1) Access Time âš¡", "Frontend, Backend, You-end. ðŸ«µ", "Full Stack Mastery ðŸ¥ž", "Deploying knowledge... ðŸš€",
            "Hot Reload your brain ðŸ”¥", "Time to merge knowledge ðŸ”€", "Pull Request: Approved âœ…", "Reviewing... ðŸ§",
            "Compiling... âš™ï¸", "Runtime Error: Lack of coffee â˜•", "Stack Overflow? Not today. ðŸ›¡ï¸", "Documentation is good, memory is better ðŸ“š",
            "Clean Code, Clean Mind ðŸ§¹", "Refactoring legacy knowledge ðŸ›ï¸", "Technical Debt repayment time ðŸ’¸", "Sprint Planning: Study Session ðŸƒ",
            "Standup meeting with yourself ðŸ§", "Blockers? None. ðŸš§", "Feature Flag: Smart ðŸš©", "CI/CD: Continuous Improvement ðŸ”„",
            "Dockerize your skills ðŸ³", "Kubernetes of knowledge â˜¸ï¸", "Scalable Learning ðŸ“ˆ", "High Availability Brain ðŸ§ ", "Load Balancing study time âš–ï¸"
        ];

        // --- MAIN APP ---
        function App() {
            const [autoResume, setAutoResume] = useState(() => localStorage.getItem('ss_auto_resume') === 'true');
            // Lazy load - Only if autoResume is true
            const [view, setView] = useState(() => (autoResume && localStorage.getItem('ss_view')) || 'home');

            const [cards, setCards] = useState([]);
            const [history, setHistory] = useState([]);
            const [bookmarks, setBookmarks] = useState([]);
            const [wrongQueue, setWrongQueue] = useState([]);
            const [streak, setStreak] = useState({ count: 0, lastDate: null, history: {} });

            const [activeDeck, setActiveDeck] = useState(() => {
                if (!autoResume) return [];
                try {
                    return JSON.parse(localStorage.getItem('ss_active_deck')) || [];
                } catch {
                    return [];
                }
            });
            const [toast, setToast] = useState(null);

            const [xp, setXp] = useState(() => parseInt(localStorage.getItem('ss_xp')) || 0);
            const [notes, setNotes] = useState({});
            const [srsData, setSrsData] = useState({});
            const [customCards, setCustomCards] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showCreator, setShowCreator] = useState(false);
            const [editingCard, setEditingCard] = useState(null);
            const [restoreSuccess, setRestoreSuccess] = useState(false); // New State for Custom Restore Modal

            // Leveling Logic
            const level = Math.floor(Math.sqrt(xp / 25)) + 1;
            const nextLevelXp = Math.pow(level, 2) * 25;
            const prevLevelXp = Math.pow(level - 1, 2) * 25;
            const levelProgress = ((xp - prevLevelXp) / (nextLevelXp - prevLevelXp)) * 100;

            const addXp = (amount) => {
                const newXp = xp + amount;
                setXp(newXp);
                localStorage.setItem('ss_xp', newXp);
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };
            const [darkMode, setDarkMode] = useState(false);
            const [useAIStudio, setUseAIStudio] = useState(false);
            const [selectedVoice, setSelectedVoice] = useState('');
            const [voices, setVoices] = useState([]);
            const [srsSettings, setSrsSettings] = useState({
                hard: { val: 0.5, unit: 'd' },
                good: { val: 1, unit: 'd' },
                easy: { val: 4, unit: 'd' }

            });
            const [notificationSettings, setNotificationSettings] = useState(() => {
                const saved = localStorage.getItem('ss_notifications');
                return saved ? JSON.parse(saved) : { enabled: false, days: [0, 1, 2, 3, 4, 5, 6], times: ["09:00"], lastNotified: 0 };
            });

            // Notification Scheduler
            useEffect(() => {
                if (!notificationSettings.enabled) return;

                const check = () => {
                    const now = new Date();
                    const day = now.getDay(); // 0-6
                    const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                    if (notificationSettings.days.includes(day) && notificationSettings.times.includes(time)) {
                        // Check debounce (prevent multi-firing in same minute if interval drifts, though set to 60s)
                        const latence = Date.now() - notificationSettings.lastNotified;
                        if (latence > 60000) {
                            // Trigger
                            const msg = NOTIFICATION_TEMPLATES[Math.floor(Math.random() * NOTIFICATION_TEMPLATES.length)];
                            showToast("ðŸ”” " + msg); // Visible confirmation inside app

                            if (Notification.permission === 'granted') {
                                new Notification("Senior Swipe", { body: msg, icon: 'icon.png' });
                            }
                            // Update lastNotified to avoid repeat
                            setNotificationSettings(prev => {
                                const next = { ...prev, lastNotified: Date.now() };
                                localStorage.setItem('ss_notifications', JSON.stringify(next));
                                return next;
                            });
                        }
                    }
                };

                const interval = setInterval(check, 10000); // Check every 10s closely to catch the minute
                return () => clearInterval(interval);
            }, [notificationSettings]);

            const updateNotifications = (newSettings) => {
                setNotificationSettings(newSettings);
                localStorage.setItem('ss_notifications', JSON.stringify(newSettings));
            };

            useEffect(() => {
                const loadVoices = () => {
                    setVoices(window.speechSynthesis.getVoices());
                };
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices();
            }, []);

            useEffect(() => {
                // 1. Load Data
                const externalData = (typeof SEED_DATA !== 'undefined') ? SEED_DATA : [];

                // Async Load & Migrate Custom Cards
                const loadCustom = async () => {
                    try {
                        let dbCards = await CustomCardDB.getAll();

                        // Migration Check
                        const legacy = localStorage.getItem('ss_custom_cards');
                        if (legacy) {
                            const parsed = JSON.parse(legacy);
                            if (parsed.length > 0) {
                                for (const c of parsed) {
                                    // Avoid duplicates if already migrated partially
                                    if (!dbCards.find(d => d.id === c.id)) {
                                        await CustomCardDB.save(c);
                                        dbCards.push(c);
                                    }
                                }
                            }
                            localStorage.removeItem('ss_custom_cards');
                        }

                        setCustomCards(dbCards);
                        setCards(prev => {
                            // Merge Strategy: DB Cards override External Data (Seed)
                            const cardMap = new Map();
                            externalData.forEach(c => cardMap.set(String(c.id), c));
                            dbCards.forEach(c => cardMap.set(String(c.id), c)); // Overwrite if exists
                            return Array.from(cardMap.values());
                        });
                    } catch (e) {
                        console.error("Custom Card Load Error", e);
                        // Fallback to allow app to run even if DB fails
                        setCards([...externalData]);
                    }
                };
                loadCustom();

                // 2. Load Persisted State


                const h = localStorage.getItem('ss_history');
                const b = localStorage.getItem('ss_bookmarks');
                const w = localStorage.getItem('ss_wrongQueue');
                const s = localStorage.getItem('ss_streak');
                const d = localStorage.getItem('ss_dark');
                const ai = localStorage.getItem('ss_use_ai_studio');
                const v = localStorage.getItem('ss_voice');
                const savedSrsSettings = localStorage.getItem('ss_srs_settings');

                if (h) setHistory(JSON.parse(h));
                if (b) setBookmarks(JSON.parse(b));
                if (w) setWrongQueue(JSON.parse(w));
                if (s) setStreak(JSON.parse(s));
                if (v) setSelectedVoice(v);
                if (savedSrsSettings) setSrsSettings(JSON.parse(savedSrsSettings));

                // Load SRS Data
                const savedSrsData = localStorage.getItem('ss_srs_data');
                if (savedSrsData) setSrsData(JSON.parse(savedSrsData));

                const n = localStorage.getItem('ss_notes');
                if (n) setNotes(JSON.parse(n));

                // Dark Mode Init
                if (d === 'true') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }

                if (ai === 'true') {
                    setUseAIStudio(true);
                }
            }, []);

            const toggleDarkMode = () => {
                const newVal = !darkMode;
                setDarkMode(newVal);
                if (newVal) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('ss_dark', newVal);
            };

            const toggleAIStudio = () => {
                const newVal = !useAIStudio;
                setUseAIStudio(newVal);
                localStorage.setItem('ss_use_ai_studio', newVal);
            };

            const updateVoice = (voiceName) => {
                setSelectedVoice(voiceName);
                localStorage.setItem('ss_voice', voiceName);
            };

            const updateSrsSettings = (key, field, val) => {
                const current = srsSettings[key] || { val: 0, unit: 'd' };
                // If existing state implies old format (number), convert to object
                const safeCurrent = typeof current === 'number' ? { val: current, unit: 'd' } : current;

                const newObj = { ...safeCurrent, [field]: val };
                const newSettings = { ...srsSettings, [key]: newObj };

                setSrsSettings(newSettings);
                localStorage.setItem('ss_srs_settings', JSON.stringify(newSettings));
            };

            const updateNotes = (cardId, text) => {
                const newNotes = { ...notes, [cardId]: text };
                setNotes(newNotes);
                localStorage.setItem('ss_notes', JSON.stringify(newNotes));
            };

            const updateHistory = (newHist) => { setHistory(newHist); localStorage.setItem('ss_history', JSON.stringify(newHist)); };
            const updateBookmarks = (newBook) => { setBookmarks(newBook); localStorage.setItem('ss_bookmarks', JSON.stringify(newBook)); };
            const updateWrongQueue = (newQ) => { setWrongQueue(newQ); localStorage.setItem('ss_wrongQueue', JSON.stringify(newQ)); };

            const updateStreak = () => {
                const today = new Date().toDateString();
                const newHistory = { ...streak.history, [today]: (streak.history[today] || 0) + 1 };

                let newCount = streak.count;
                if (streak.lastDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (streak.lastDate === yesterday.toDateString()) newCount++;
                    else if (streak.lastDate !== today) newCount = 1;
                }

                const newStreak = { count: newCount, lastDate: today, history: newHistory };
                setStreak(newStreak);
                localStorage.setItem('ss_streak', JSON.stringify(newStreak));
            };

            // SRS Logic (Correctly scoped)
            // SRS Logic (Correctly scoped)
            const handleSrsReview = (id, rating) => {
                const NOW = Date.now();
                const existing = srsData[id] || { interval: 0, ease: 2.5, streak: 0 };
                let { interval, ease } = existing;
                let streak = existing.streak || 0;

                // Helper to get raw minutes
                const getMins = (setting) => {
                    const s = setting || { val: 1, unit: 'd' }; // default safety
                    let v = s.val || s; // handle legacy number
                    let u = s.unit || 'd';
                    if (u === 'm') return v;
                    if (u === 'h') return v * 60;
                    return v * 24 * 60; // days to mins
                };

                // Rating: 0=Again, 1=Hard, 2=Good, 3=Easy
                if (rating === SRS.AGAIN) {
                    streak = 0;
                    interval = 0; // 0 mins
                } else if (rating === SRS.HARD) {
                    streak = 0;
                    interval = getMins(srsSettings.hard);
                } else if (rating === SRS.GOOD) {
                    streak++;
                    interval = streak === 1 ? getMins(srsSettings.good) : interval * ease;
                } else if (rating === SRS.EASY) {
                    streak++;
                    ease += 0.15;
                    interval = streak === 1 ? getMins(srsSettings.easy) : interval * ease * 1.3;
                }

                if (ease < 1.3) ease = 1.3;

                // Calc Next Review
                let nextReview;
                if (interval === 0) {
                    nextReview = NOW + (60 * 1000); // 1 min for mistakes
                } else {
                    nextReview = NOW + (interval * 60 * 1000);
                }

                const newData = { ...srsData, [id]: { interval, ease, streak, nextReview } };
                setSrsData(newData);
                localStorage.setItem('ss_srs_data', JSON.stringify(newData));

                // Legacy Sync
                if (rating >= SRS.GOOD) {
                    if (!history.includes(id)) updateHistory([...history, id]);
                    if (wrongQueue.includes(id)) updateWrongQueue(wrongQueue.filter(x => x !== id));
                } else {
                    if (!wrongQueue.includes(id)) updateWrongQueue([...wrongQueue, id]);
                }
            };



            const toggleBookmark = (id) => {
                if (bookmarks.includes(id)) updateBookmarks(bookmarks.filter(b => b !== id));
                else updateBookmarks([...bookmarks, id]);
            };



            const addCustomCard = async (card) => {
                await CustomCardDB.save(card);
                const newCustom = [...customCards, card];
                setCustomCards(newCustom);
                setCards(prev => [...prev, card]);
                setShowCreator(false);
                showToast("Card Created!");
            };

            const updateCard = async (card) => {
                await CustomCardDB.save(card); // Save/Overwrite
                // Update State (Handle Merge Logic again essentially, or just iterate)
                setCards(prev => prev.map(c => String(c.id) === String(card.id) ? card : c));
                setCustomCards(prev => {
                    const idx = prev.findIndex(c => String(c.id) === String(card.id));
                    if (idx > -1) {
                        const copy = [...prev];
                        copy[idx] = card;
                        return copy;
                    }
                    return [...prev, card];
                });
                setShowCreator(false);
                showToast("Card Updated!");
            };

            const exportData = () => {
                const data = {
                    history, bookmarks, xp, streak, customCards, srsData, wrongQueue, notes,
                    settings: { darkMode, srsSettings, notificationSettings, useAIStudio, voice: selectedVoice, autoResume }
                };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `senior_swipe_backup_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const input = e.target;

                // Decouple from UI thread and ensure input clearing works across browsers
                setTimeout(() => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (!data) throw new Error("File appears empty");

                            // 1. Direct LocalStorage Writes (No React State Updates)
                            const simpleKeys = ['history', 'bookmarks', 'xp', 'streak', 'wrongQueue', 'srsData', 'notes'];
                            simpleKeys.forEach(k => {
                                if (data[k]) localStorage.setItem('ss_' + k, typeof data[k] === 'object' ? JSON.stringify(data[k]) : data[k]);
                            });
                            // Special case for srs_data name mismatch in simpleKeys logic if any (srsData->ss_srs_data map matches)

                            // 2. Settings
                            if (data.settings) {
                                const s = data.settings;
                                if (s.darkMode !== undefined) localStorage.setItem('ss_dark', s.darkMode);
                                if (s.srsSettings) localStorage.setItem('ss_srs_settings', JSON.stringify(s.srsSettings));
                                if (s.notificationSettings) localStorage.setItem('ss_notifications', JSON.stringify(s.notificationSettings));
                                if (s.useAIStudio !== undefined) localStorage.setItem('ss_use_ai_studio', s.useAIStudio);
                                if (s.voice) localStorage.setItem('ss_voice', s.voice);
                                if (s.autoResume !== undefined) localStorage.setItem('ss_auto_resume', s.autoResume);
                            }

                            // 3. Custom Cards
                            if (data.customCards) localStorage.setItem('ss_custom_cards', JSON.stringify(data.customCards));

                            // 4. Success UI
                            setRestoreSuccess(true);
                            setShowSettings(false);

                        } catch (err) {
                            alert("Restore Failed: " + err.message);
                            console.error(err);
                        } finally {
                            // Clear input AFTER reading is done
                            input.value = '';
                        }
                    };
                    reader.readAsText(file);
                }, 50);
            };

            const resetApp = () => {
                // Confirmation handled by Modal, this is final execution
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('ss_')) localStorage.removeItem(key);
                });
                window.location.reload();
            };



            const textToId = (text) => {
                // Simple hash to get ID from text if real ID missing
                return text.length;
            };

            const startSession = (category, mode = 'smart', sortMode = 'smart', range = null) => {
                let pool = [];

                if (category === 'Mistakes') {
                    pool = cards.filter(c => wrongQueue.includes(c.id));
                    if (pool.length === 0) { showToast("No mistakes to review!"); return; }
                } else if (category === 'Bookmarks') {
                    pool = cards.filter(c => bookmarks.includes(c.id));
                } else {
                    if (Array.isArray(category)) {
                        if (category.length > 0) {
                            // Check if it's a list of IDs (Top 500 feature)
                            if (typeof category[0] === 'number') {
                                pool = cards.filter(c => category.includes(c.id));
                            } else if (!category.includes('All')) {
                                // List of Category Names
                                pool = cards.filter(c => category.includes(c.category));
                            } else {
                                pool = [...cards];
                            }
                        } else {
                            // Empty array
                            pool = [];
                        }
                    } else if (typeof category === 'string' && category !== 'All') {
                        pool = cards.filter(c => c.category === category);
                    } else {
                        pool = [...cards];
                    }
                }

                if (pool.length === 0) { showToast("No available cards."); return; }

                // Strict SRS (Due Only)
                if (range && range.dueOnly) {
                    const duePool = pool.filter(c => {
                        const srs = srsData[c.id];
                        return srs && Date.now() > srs.nextReview;
                    });
                    if (duePool.length > 0) {
                        pool = duePool;
                    } else {
                        // Optional: Fallback or Alert
                        showToast("No cards due for review! Starting standard session.");
                        // We just proceed with 'pool' as is (standard smart shuffle fallback)
                    }
                }

                // Apply Sorting
                let finalDeck = [];
                if (sortMode === 'sequential') {
                    finalDeck = pool.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                } else {
                    // Smart Shuffle
                    finalDeck = pool.map(c => {
                        let weight = 1;
                        // SRS Weighting
                        const srs = srsData[c.id];
                        if (srs) {
                            if (Date.now() > srs.nextReview) weight = 10; // Due for review
                            else weight = 0.1; // Not due
                        } else {
                            // New card
                            if (wrongQueue.includes(c.id)) weight = 5;
                            else if (!history.includes(c.id)) weight = 3;
                        }
                        return { card: c, sort: Math.random() * weight };
                    }).sort((a, b) => b.sort - a.sort).map(wp => wp.card);
                }

                // Apply Limit
                const limit = (range && range.limit) ? range.limit : 15;
                setActiveDeck(finalDeck.slice(0, limit));
                setView('play');
            };

            const handleSessionComplete = (learnedIds, newMistakes = []) => {
                updateHistory([...new Set([...history, ...learnedIds])]);
                updateWrongQueue([...new Set([...wrongQueue, ...newMistakes])]);
                updateStreak();
                addXp(50); // Session bonus
                setToast("Session Complete! +50 XP");
            };

            const renderView = () => {
                switch (view) {
                    case 'home': return <HomeView cards={cards} history={history} bookmarks={bookmarks} streak={streak} wrongQueue={wrongQueue} darkMode={darkMode} toggleDarkMode={toggleDarkMode} onStart={startSession} onNav={setView} xp={xp} level={level} levelProgress={levelProgress} setShowSettings={setShowSettings} setShowCreator={setShowCreator} srsData={srsData} updateStreak={updateStreak} />;
                    case 'browser': return <BrowserView cards={cards} bookmarks={bookmarks} onToggleBookmark={toggleBookmark} onNav={setView} history={history} onEdit={(card) => { setEditingCard(card); setShowCreator(true); }} />;
                    case 'notes': return <NotesView cards={cards} notes={notes} onNav={setView} />;
                    case 'play': return <PlayView deck={activeDeck} bookmarks={bookmarks} onToggleBookmark={toggleBookmark} onFinish={handleSessionComplete} onNav={setView} history={history} showToast={showToast} addXp={addXp} onSrsReview={handleSrsReview} notes={notes} onUpdateNote={updateNotes} useAIStudio={useAIStudio} voiceName={selectedVoice} srsSettings={srsSettings} />;
                    default: return <HomeView />;
                }
            };

            // Persistence for Session
            useEffect(() => {
                if (!autoResume) {
                    if (view === 'home') {
                        localStorage.removeItem('ss_view');
                        localStorage.removeItem('ss_active_deck');
                        localStorage.removeItem('ss_session_index');
                    }
                    return;
                }

                localStorage.setItem('ss_view', view);
                if (view === 'play') {
                    localStorage.setItem('ss_active_deck', JSON.stringify(activeDeck));
                } else {
                    localStorage.removeItem('ss_active_deck');
                    localStorage.removeItem('ss_session_index');
                }
            }, [view, activeDeck, autoResume]);

            const toggleAutoResume = () => {
                const newVal = !autoResume;
                setAutoResume(newVal);
                localStorage.setItem('ss_auto_resume', newVal);
                if (!newVal) {
                    // Clear state immediately if turned off
                    localStorage.removeItem('ss_view');
                    localStorage.removeItem('ss_active_deck');
                    localStorage.removeItem('ss_session_index');
                } else {
                    // Save state immediately if turned on
                    localStorage.setItem('ss_view', view);
                    if (view === 'play') localStorage.setItem('ss_active_deck', JSON.stringify(activeDeck));
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white dark:bg-zinc-950 shadow-2xl relative font-sans text-slate-800 dark:text-zinc-200">
                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        onExport={exportData}
                        onImport={importData}
                        useAIStudio={useAIStudio}
                        onToggleAIStudio={toggleAIStudio}
                        voices={voices}
                        currentVoice={selectedVoice}
                        onVoiceChange={updateVoice}
                        srsSettings={srsSettings}
                        onSrsChange={updateSrsSettings}
                        autoResume={autoResume}
                        onToggleAutoResume={toggleAutoResume}
                        notificationSettings={notificationSettings}
                        onNotificationChange={updateNotifications}
                        onReset={resetApp}
                    />
                    {showCreator && <CardCreatorView categories={[...new Set(cards.map(c => c.category))]} onClose={() => { setShowCreator(false); setEditingCard(null); }} onSave={editingCard ? updateCard : addCustomCard} initialData={editingCard} />}

                    <ConfirmDialog
                        isOpen={restoreSuccess}
                        title="Restore Successful! âœ¨"
                        message="Your data has been loaded successfully. The app needs to reload to apply the changes."
                        onConfirm={() => window.location.reload()}
                        confirmText="Reload App"
                        confirmColor="bg-green-600 hover:bg-green-700"
                        onCancel={null} // Force reload by removing cancel option
                    />

                    {renderView()}
                    {toast && <Toast message={toast} />}
                </div>
            );
        }

        const HomeView = ({ cards, history, bookmarks, streak, wrongQueue, darkMode, toggleDarkMode, onStart, onNav, xp, level, levelProgress, setShowSettings, setShowCreator, srsData, updateStreak }) => {
            // Derive categories from cards
            const categories = useMemo(() => [...new Set(cards.map(c => c.category))], [cards]);

            // Calculate overall mastery
            const mastery = useMemo(() => {
                if (!cards.length) return 0;
                return (history.length / cards.length) * 100;
            }, [cards, history]);


            // Radar Data
            const radarData = useMemo(() => {
                const cats = categories.slice(0, 6); // Use actual top 6 categories
                return cats.map(cat => {
                    const catCards = cards.filter(c => c.category === cat);
                    if (!catCards.length) return { label: cat, value: 0 };
                    const learned = catCards.filter(c => history.includes(c.id)).length;
                    // Boost value if SRS says "easy"
                    const mastery = (learned / catCards.length) * 100;
                    return { label: cat, value: mastery || 10 }; // Min 10 for visibility
                });
            }, [cards, history]);

            // Heatmap Data (Last 7 days)
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                dates.push(d.toDateString());
            }

            const [selectedCats, setSelectedCats] = useState([]);
            const [isSelectMode, setIsSelectMode] = useState(false);
            const [catSort, setCatSort] = useState('default'); // default, count_desc, count_asc

            const getCategoryCount = (cat) => cards.filter(c => c.category === cat).length;

            const getPhase = (cat) => {
                const sampleCard = cards.find(c => c.category === cat);
                if (!sampleCard) return 'Additional Topics';
                const id = parseInt(sampleCard.id);

                if ((id >= 2000 && id < 3000) || (id >= 5000 && id < 6000) || (id >= 6000 && id < 7000) || (id >= 7000 && id < 8000)) return 'Phase 1: The "Must Know"';
                if ((id >= 12000 && id < 13000) || (id >= 14000 && id < 15000) || (id >= 27000 && id < 28000)) return 'Phase 2: The "Senior Badge"';
                if ((id >= 24000 && id < 25000) || (id >= 25000 && id < 26000) || (id >= 37000 && id < 38000)) return 'Phase 3: The "Production Ready"';
                if ((id >= 1000 && id < 2000) || (id >= 38000) || cat.includes('Algorithm')) return 'Phase 4: The "Extra Mile"';
                return 'Additional Topics';
            };

            const phasedCategories = useMemo(() => {
                const groups = {
                    'Phase 1: The "Must Know"': [],
                    'Phase 2: The "Senior Badge"': [],
                    'Phase 3: The "Production Ready"': [],
                    'Phase 4: The "Extra Mile"': [],
                    'Additional Topics': []
                };

                let sorted = [...categories];

                sorted.forEach(cat => {
                    const phase = getPhase(cat);
                    if (groups[phase]) groups[phase].push(cat);
                    else groups['Additional Topics'].push(cat);
                });

                // Sort within groups
                Object.keys(groups).forEach(key => {
                    if (catSort === 'count_desc') groups[key].sort((a, b) => getCategoryCount(b) - getCategoryCount(a));
                    else if (catSort === 'count_asc') groups[key].sort((a, b) => getCategoryCount(a) - getCategoryCount(b));
                    else groups[key].sort();
                });

                return groups;
            }, [categories, catSort, cards]);

            const toggleCatSort = () => {
                if (catSort === 'default') setCatSort('count_desc');
                else if (catSort === 'count_desc') setCatSort('count_asc');
                else setCatSort('default');
            };

            const toggleCategorySelect = (cat) => {
                if (selectedCats.includes(cat)) {
                    const newCats = selectedCats.filter(c => c !== cat);
                    setSelectedCats(newCats);
                } else {
                    setSelectedCats([...selectedCats, cat]);
                }
            };
            const handleStartSession = () => {
                onStart(selectedCats, 'study');
            };

            // Ranking Logic (Static ID Lists provided by User)
            const rankedQueues = useMemo(() => {
                const top100 = [
                    60001, 60003, 60006, 60007, 60009, 60012, 60018, 60019, 60022, 60027,
                    60030, 60033, 60035, 60036, 60038, 60040, 60046, 60047, 60048, 60050,
                    60051, 60053, 60054, 60058, 60061, 60151, 60153, 60154, 60155, 60156,
                    60157, 60158, 60161, 60162, 50052, 50053, 50055, 50059, 50060, 50064,
                    50066, 50080, 50081, 50091, 50093, 50096, 50102, 50112, 50118, 50131,
                    60101, 60102, 60103, 60106, 60121, 60122, 60123, 60124, 60125, 60128,
                    60130, 60131, 60132, 60133, 60145, 60146, 60147, 60148, 60169, 60175,
                    60067, 60070, 60071, 60072, 60075, 60076, 60080, 60082, 60085, 60086,
                    60088, 60093, 60164, 60165, 60166, 60167, 60168, 60223, 60225, 60227,
                    60181, 60182, 60183, 60184, 60186, 60187, 60191, 60201, 60209, 60222
                ];

                const top150 = [
                    12051, 12052, 12053, 12056, 12057, 12058, 12060, 12061, 12063, 12064,
                    12065, 12070, 12071, 12076, 12080, 12084, 12089, 12090, 12096, 12101,
                    12102, 12103, 12110, 12115, 12118, 12120, 12121, 12126, 12128, 12141,
                    6051, 6052, 6054, 6055, 6057, 6058, 6059, 6060, 6061, 6064,
                    6070, 6071, 6078, 6081, 6082, 6084, 6088, 6089, 6091, 6092,
                    6101, 6102, 6104, 6109, 6110, 6128, 6129, 6142, 6164, 6169,
                    27051, 27052, 27053, 27054, 27056, 27060, 27061, 27065, 27066, 27068,
                    27073, 27077, 27078, 27080, 27086, 27087, 27088, 27091, 27101, 27102,
                    27105, 27110, 27122, 27127, 27129, 27135, 27140, 27145, 27147, 27151,
                    63001, 63003, 63005, 63006, 63007, 63009, 63015, 63024, 63028, 63045,
                    63046, 63022, 63017, 63004, 63011,
                    64001, 64003, 64004, 64005, 64008, 64013, 64017, 64018, 64023, 64024,
                    64028, 64030, 64032, 64041, 64002,
                    60101, 60104, 60106, 60113, 60115, 60118, 60121, 60123, 60130, 60135,
                    60136, 60141, 60151, 60152, 60156, 60160, 60161, 60166, 60168, 60174,
                    60176, 60182, 60183, 60184, 60186, 60189, 60191, 60216, 60219, 60220
                ];

                const top250 = [
                    41051, 41052, 41053, 41054, 41055, 41056, 41057, 41058, 41059, 41060,
                    41061, 41062, 41063, 41064, 41065, 41066, 41067, 41068, 41069, 41070,
                    41071, 41072, 41073, 41074, 41075, 41076, 41077, 41078, 41079, 41080,
                    41081, 41082, 41083, 41084, 41085, 41086, 41087, 41088, 41089, 41090,
                    41091, 41092, 41093, 41094, 41095, 41096, 41097, 41098, 41099, 41100,
                    41101, 41102, 41103, 41104, 41105, 41106, 41107, 41108, 41109, 41110,
                    41111, 41112, 41113, 41114, 41115, 41116, 41117, 41118, 41119, 41120,
                    41121, 41122, 41123, 41124, 41125, 41126, 41127, 41128, 41129, 41130,
                    41131, 41132, 41133, 41134, 41135, 41136, 41137, 41138, 41139, 41140,
                    41141, 41142, 41143, 41144, 41145, 41146, 41147, 41148, 41149, 41150,
                    41151, 41152, 41153, 41154, 41155, 41156, 41157, 41158, 41159, 41160,
                    41161, 41162, 41163, 41164, 41165, 41166, 41167, 41168, 41169, 41170,
                    41171, 41172, 41173, 41174, 41175, 41176, 41177, 41178, 41179, 41180,
                    41181, 41182, 41183, 41184, 41185, 41186, 41187, 41188, 41189, 41190,
                    41191, 41192, 41193, 41194, 41195, 41196, 41197, 41198, 41199, 41200,
                    61001, 61002, 61003, 61004, 61005, 61006, 61007, 61008, 61009, 61010,
                    61011, 61012, 61013, 61014, 61015, 61016, 61017, 61018, 61019, 61020,
                    61021, 61022, 61023, 61024, 61025, 61026, 61027, 61028, 61029, 61030,
                    61031, 61032, 61033, 61034, 61035, 61036, 61037, 61038, 61039, 61040,
                    61041, 61042, 61043, 61044, 61045, 61046, 61047, 61048, 61049, 61050,
                    61051, 61052, 61053, 61054, 61055, 61056, 61057, 61058, 61059, 61060,
                    61061, 61062, 61063, 61064, 61065, 61066, 61067, 61068, 61069, 61070,
                    61071, 61072, 61073, 61074, 61075, 61076, 61077, 61078, 61079, 61080,
                    61081, 61082, 61083, 61084, 61085, 61086, 61087, 61088, 61089, 61090,
                    61091, 61092, 61093, 61094, 61095, 61096, 61097, 61098, 61099, 61100
                ];

                return { top100, top150, top250 };
            }, []); // No dependencies needed as lists are static

            const [showRoadmap, setShowRoadmap] = useState(false);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-zinc-950 relative">
                    <LevelRoadmapModal isOpen={showRoadmap} onClose={() => setShowRoadmap(false)} currentXp={xp} currentLevel={level} />

                    {/* Sticky Header */}
                    <div className="sticky top-0 z-40 bg-white/90 dark:bg-zinc-950/90 backdrop-blur-md border-b border-slate-200/50 dark:border-zinc-800/50 px-6 py-4 transition-colors duration-300">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <img src="icon.png" className="w-8 h-8 rounded-lg shadow-sm" alt="Logo" />
                                <div className="cursor-pointer" onClick={() => setShowRoadmap(true)}>
                                    <h1 className="text-xl font-black text-slate-800 dark:text-white leading-none">Senior Swipe</h1>
                                    <div className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mt-1 flex items-center gap-1">Lv.{level} Developer <Icons.Wrench size={10} /></div>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={toggleDarkMode} className="p-2 bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors">{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
                                <button onClick={() => updateStreak() || setShowSettings(true)} className="p-2 bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-700 transition-colors"><Icons.Wrench /></button>
                                <button onClick={() => onNav('notes')} className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors"><Icons.Book /></button>
                                <button onClick={() => onNav('browser')} className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors"><Icons.Search /></button>
                            </div>
                        </div>
                    </div>

                    {/* Stats Card Area */}
                    <div className="px-6 pt-6 pb-2 bg-slate-50 dark:bg-zinc-950">
                        <div className="bg-zinc-900 dark:bg-zinc-900 text-white p-5 rounded-2xl shadow-lg border border-zinc-800 relative overflow-hidden">
                            {/* Level Progress Background */}
                            <div className="absolute top-0 left-0 h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500" style={{ width: `${levelProgress}%` }}></div>

                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2 text-yellow-400 font-bold"><Icons.Flame fill="currentColor" /> {streak.count} Day Streak</div>
                                <div className="flex gap-1">{dates.map(d => <div key={d} className={`w-2 h-6 rounded-full ${streak.history[d] ? 'bg-green-500' : 'bg-zinc-700'}`}></div>)}</div>
                            </div>
                            <div className="flex justify-between text-sm mb-1 text-slate-400"><span>Mastery</span><span>{history.length} / {cards.length}</span></div>
                            <div className="w-full bg-zinc-800 h-2 rounded-full overflow-hidden mb-4"><div className="bg-indigo-500 h-full transition-all duration-1000" style={{ width: `${mastery}%` }}></div></div>
                            <div className="flex gap-4">
                                <div className="flex-1 bg-zinc-800 rounded-lg p-2 text-center clickable" onClick={() => onStart('Bookmarks', 'study')}><div className="text-xl font-bold text-yellow-400">{bookmarks.length}</div><div className="text-[10px] uppercase tracking-wider text-slate-400">Bookmarks</div></div>
                                <div className="flex-1 bg-zinc-800 rounded-lg p-2 text-center" onClick={() => onStart('Mistakes', 'study')}><div className="text-xl font-bold text-red-400">{wrongQueue.length}</div><div className="text-[10px] uppercase tracking-wider text-slate-400">Mistakes</div></div>
                            </div>
                            <div className="flex justify-center mt-6">
                                <RadarChart data={radarData} size={220} />
                            </div>
                        </div>
                    </div>

                    <div className="pt-4 pb-20">
                        {/* Curated Paths (Top 500) */}
                        <div className="px-6 mb-8">
                            <h2 className="font-bold text-slate-700 dark:text-zinc-500 text-sm uppercase tracking-wide mb-4">Curated Mastery Paths</h2>
                            <div className="space-y-3">
                                <div onClick={() => onStart(rankedQueues.top100, 'study')} className="bg-gradient-to-r from-rose-500 to-orange-500 rounded-xl p-4 shadow-lg shadow-orange-500/20 active:scale-98 transition-transform cursor-pointer relative overflow-hidden group">
                                    <div className="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-16 -mt-16 transition-all group-hover:bg-white/20"></div>
                                    <div className="relative z-10 flex justify-between items-center">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <div className="text-white/80 text-[10px] font-bold uppercase tracking-wider">High Priority</div>
                                                <button onClick={(e) => { e.stopPropagation(); onStart(rankedQueues.top100, 'study', 'smart', { limit: 9999 }); }} className="text-[9px] font-bold text-white/70 hover:text-white bg-white/20 hover:bg-white/30 px-2 py-0.5 rounded-full transition-colors">Show All</button>
                                            </div>
                                            <h3 className="text-white text-lg font-black leading-tight">Top 100 Matches</h3>
                                            <p className="text-white/90 text-xs mt-1 font-medium">Core Concepts & Must-Knows</p>
                                        </div>
                                        <div className="h-10 w-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                            <Icons.Flame size={20} className="text-white" fill="currentColor" />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div onClick={() => onStart(rankedQueues.top150, 'study')} className="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl p-4 shadow-lg shadow-blue-500/20 active:scale-98 transition-transform cursor-pointer relative overflow-hidden group">
                                        <div className="relative z-10">
                                            <div className="flex justify-between items-start">
                                                <div className="text-blue-100 text-[9px] font-bold uppercase tracking-wider mb-1">Mid Tier</div>
                                                <button onClick={(e) => { e.stopPropagation(); onStart(rankedQueues.top150, 'study', 'smart', { limit: 9999 }); }} className="text-[9px] font-bold text-blue-200 hover:text-white bg-blue-500/40 hover:bg-blue-500/60 px-1.5 py-0.5 rounded transition-colors">Show All</button>
                                            </div>
                                            <h3 className="text-white text-sm font-black leading-tight">Next 150</h3>
                                            <p className="text-blue-100/80 text-[10px] mt-1">Architecture & Design</p>
                                        </div>
                                        <Icons.Play size={32} className="absolute -bottom-2 -right-2 text-white/10 group-hover:text-white/20 transition-colors" fill="currentColor" />
                                    </div>

                                    <div onClick={() => onStart(rankedQueues.top250, 'study')} className="bg-zinc-800 dark:bg-zinc-800 rounded-xl p-4 border border-zinc-700 active:scale-98 transition-transform cursor-pointer relative overflow-hidden group hover:border-zinc-600">
                                        <div className="relative z-10">
                                            <div className="flex justify-between items-start">
                                                <div className="text-zinc-400 text-[9px] font-bold uppercase tracking-wider mb-1">Low Priority</div>
                                                <button onClick={(e) => { e.stopPropagation(); onStart(rankedQueues.top250, 'study', 'smart', { limit: 9999 }); }} className="text-[9px] font-bold text-zinc-500 hover:text-white bg-zinc-700 hover:bg-zinc-600 px-1.5 py-0.5 rounded transition-colors">Show All</button>
                                            </div>
                                            <h3 className="text-white text-sm font-black leading-tight">Next 250</h3>
                                            <p className="text-zinc-500 text-[10px] mt-1">Niche & Deep Dives</p>
                                        </div>
                                        <Icons.Search size={32} className="absolute -bottom-2 -right-2 text-white/5 group-hover:text-white/10 transition-colors" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="px-6 flex justify-between items-center mb-4">
                            <h2 className="font-bold text-slate-700 dark:text-zinc-500 text-sm uppercase tracking-wide">Browse Categories</h2>
                            <button onClick={() => setShowCreator(true)} className="text-xs font-bold text-indigo-600">+ New Card</button>
                        </div>
                        {Object.entries(phasedCategories).map(([phaseName, phaseCats]) => (
                            phaseCats.length > 0 && (
                                <div key={phaseName} className="mb-6">
                                    <div className="px-6 flex justify-between items-center mb-3">
                                        <h2 className="font-bold text-indigo-500 dark:text-indigo-400 text-[10px] uppercase tracking-wider">{phaseName}</h2>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 px-6">
                                        {phaseCats.map(cat => {
                                            const isSelected = selectedCats.includes(cat);
                                            const count = getCategoryCount(cat);
                                            return (
                                                <div key={cat} onClick={() => toggleCategorySelect(cat)} className={`p-4 rounded-xl border-2 cursor-pointer transition-all ${isSelected ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 dark:border-indigo-500' : 'border-slate-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 hover:border-indigo-300 dark:hover:border-indigo-700'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className={`w-4 h-4 rounded-full border border-slate-300 flex items-center justify-center ${isSelected ? 'bg-indigo-600 border-indigo-600' : ''}`}>
                                                            {isSelected && <Icons.CheckCircle size={12} className="text-white" />}
                                                        </div>
                                                        <span className="text-[10px] font-bold text-slate-400">{count}</span>
                                                    </div>
                                                    <h3 className="font-bold text-slate-800 dark:text-white text-sm line-clamp-2 mb-2">{cat}</h3>
                                                    <div className="flex flex-wrap gap-1">
                                                        {[...new Set(cards.filter(c => c.category === cat).map(c => c.difficulty))].map(diff => (
                                                            <span key={diff} className={`text-[9px] px-1.5 py-0.5 rounded-[4px] font-bold tracking-wider uppercase ${diff === 'Senior' ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300' : diff === 'Principal' ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300' : 'bg-green-100 text-green-600'}`}>{diff}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )
                        ))}
                    </div>

                    {/* Floating Action Button */}
                    <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 ${selectedCats.length > 0 ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}`}>
                        <button onClick={() => setIsSelectMode(true)} className="bg-indigo-600 text-white px-8 py-4 rounded-full font-bold shadow-2xl flex items-center gap-3 hover:scale-105 active:scale-95 transition-transform">
                            <Icons.Play size={20} fill="currentColor" />
                            Start Session ({selectedCats.length})
                        </button>
                    </div>

                    <SessionSetupModal
                        isOpen={isSelectMode}
                        onClose={() => setIsSelectMode(false)}
                        onStart={(mode, range) => onStart(selectedCats, 'study', mode, range)}
                        totalCards={selectedCats.length > 0 ? cards.filter(c => selectedCats.includes(c.category)).length : cards.length}
                    />
                </div>
            );
        };

        const BrowserView = ({ cards, bookmarks, onToggleBookmark, onNav, history, onEdit }) => {
            const [search, setSearch] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('All');
            const [statusFilter, setStatusFilter] = useState('All'); // All, Learned, Mistake, Bookmark, Recorded
            const [sortOrder, setSortOrder] = useState('default'); // default, id_asc, id_desc
            const [expandedIds, setExpandedIds] = useState([]);
            const [limit, setLimit] = useState(50); // Infinite Scroll Limit
            const [recordedIds, setRecordedIds] = useState([]);
            const [confirmAction, setConfirmAction] = useState(null); // { message, onConfirm }

            useEffect(() => {
                AudioDB.getKeys().then(keys => {
                    setRecordedIds(keys);
                });
            }, []);

            const categories = ['All', ...new Set(cards.map(c => c.category))];

            const toggleExpand = (id) => {
                if (expandedIds.includes(id)) setExpandedIds(expandedIds.filter(i => i !== id));
                else setExpandedIds([...expandedIds, id]);
            };

            const filtered = cards.filter(c => {
                const matchesSearch = c.title.toLowerCase().includes(search.toLowerCase()) || c.content.toLowerCase().includes(search.toLowerCase());
                const matchesCategory = categoryFilter === 'All' || c.category === categoryFilter;

                let matchesStatus = true;
                if (statusFilter === 'Learned') matchesStatus = history.includes(c.id);
                else if (statusFilter === 'Bookmarked') matchesStatus = bookmarks.includes(c.id);
                else if (statusFilter === 'Recorded') matchesStatus = recordedIds.includes(c.id);

                return matchesSearch && matchesCategory && matchesStatus;
            });

            const displayList = [...filtered].sort((a, b) => {
                if (sortOrder === 'id_asc') return parseInt(a.id) - parseInt(b.id);
                if (sortOrder === 'id_desc') return parseInt(b.id) - parseInt(a.id);
                return 0; // Default natural order
            });

            const visibleList = displayList.slice(0, limit);

            const deleteAudio = (id) => {
                setConfirmAction({
                    message: "Are you sure you want to delete this voice recording? This cannot be undone.",
                    onConfirm: async () => {
                        await AudioDB.delete(id);
                        setRecordedIds(prev => prev.filter(k => k !== id));
                    }
                });
            };

            const toggleSort = () => {
                if (sortOrder === 'default') setSortOrder('id_asc');
                else if (sortOrder === 'id_asc') setSortOrder('id_desc');
                else setSortOrder('default');
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 dark:bg-zinc-950">
                    <div className="p-4 bg-white dark:bg-zinc-950 border-b border-slate-200 dark:border-zinc-800 sticky top-0 z-10">
                        <div className="flex flex-col gap-3 mb-3">
                            <div className="flex items-center gap-3">
                                <button onClick={() => onNav('home')} className="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full dark:text-white"><Icons.Home /></button>
                                <div className="flex-1 relative"><input type="text" placeholder="Search..." className="w-full pl-9 pr-4 py-2 bg-slate-100 dark:bg-zinc-900 dark:text-white rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" value={search} onChange={e => setSearch(e.target.value)} /><Icons.Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400 dark:text-zinc-500" /></div>
                                <button onClick={toggleSort} className={`p-2 rounded-full transition-colors ${sortOrder !== 'default' ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-400' : 'bg-slate-100 dark:bg-zinc-800 text-slate-500 dark:text-zinc-400'}`}>
                                    {sortOrder === 'id_asc' ? <Icons.Filter className="rotate-180" /> : <Icons.Filter />}
                                </button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                {categories.map(cat => (
                                    <button key={cat} onClick={() => setCategoryFilter(cat)} className={`px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-colors border ${categoryFilter === cat ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-slate-100 dark:bg-zinc-900 text-slate-500 dark:text-zinc-400 border-transparent'}`}>{cat}</button>
                                ))}
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pt-1">
                                {['All', 'Learned', 'Bookmarked', 'Recorded'].map(st => (
                                    <button key={st} onClick={() => setStatusFilter(st)} className={`px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-colors border ${statusFilter === st ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-slate-100 dark:bg-zinc-900 text-slate-500 dark:text-zinc-400 border-transparent'}`}>{st}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {visibleList.map(c => (
                            <div key={c.id} className="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 p-4">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold bg-slate-100 dark:bg-zinc-800 text-slate-500 dark:text-zinc-400`}>{c.category}</span>
                                        <span className="text-[9px] font-mono text-slate-300 dark:text-zinc-600">#{c.id}</span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => toggleExpand(c.id)} className="text-slate-400 dark:text-zinc-500 text-[10px] font-bold px-2 py-1 rounded bg-slate-100 dark:bg-zinc-800 uppercase tracking-widest hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">{expandedIds.includes(c.id) ? 'Collapse' : 'Expand'}</button>
                                        <button onClick={() => onEdit(c)} className="text-slate-300 dark:text-zinc-600 hover:text-indigo-500 dark:hover:text-indigo-400"><Icons.Edit size={18} /></button>
                                        <button onClick={() => onToggleBookmark(c.id)} className={bookmarks.includes(c.id) ? "text-yellow-400" : "text-slate-300 dark:text-zinc-600"}><Icons.Bookmark size={18} fill="currentColor" /></button>
                                    </div>
                                </div>
                                <h3 className="font-bold text-slate-800 dark:text-white text-sm mb-2"><HighlightText text={c.title} term={search} /></h3>
                                <div className={`text-xs text-slate-500 dark:text-zinc-400 ${expandedIds.includes(c.id) ? '' : 'line-clamp-2'}`}><Markdown content={c.content} searchTerm={search} /></div>
                                {expandedIds.includes(c.id) && (
                                    <div className="mt-4 pt-4 border-t border-slate-100 dark:border-zinc-800">
                                        <div className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-2">Explanation</div>
                                        <div className="text-xs text-slate-600 dark:text-zinc-300"><Markdown content={c.explanation} /></div>
                                        {recordedIds.includes(c.id) && (
                                            <div className="flex items-center gap-2 mt-2">
                                                <div className="flex-1"><AudioPlayer cardId={c.id} /></div>
                                                <button onClick={() => deleteAudio(c.id)} className="w-10 h-10 flex items-center justify-center text-red-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors"><Icons.Trash /></button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                        {displayList.length > limit && (
                            <button onClick={() => setLimit(l => l + 50)} className="w-full py-3 text-sm font-bold text-indigo-500 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors">Load More</button>
                        )}
                    </div>
                    <ConfirmationModal
                        isOpen={!!confirmAction}
                        onClose={() => setConfirmAction(null)}
                        onConfirm={confirmAction?.onConfirm}
                        message={confirmAction?.message}
                    />
                </div>
            );
        };

        const CommuterGuideModal = ({ isOpen, onClose, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl max-w-sm w-full p-6 border border-slate-200 dark:border-zinc-800 animate-in zoom-in-95">
                        <div className="flex flex-col items-center text-center mb-6">
                            <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center mb-4 text-indigo-600 dark:text-indigo-400">
                                <Icons.Headphones size={32} />
                            </div>
                            <h3 className="text-xl font-black text-slate-800 dark:text-white mb-2">Commuter Mode</h3>
                            <p className="text-sm text-slate-500 dark:text-zinc-400">Review hands-free while driving or walking. The app will read cards to you.</p>
                        </div>

                        <div className="bg-slate-50 dark:bg-zinc-800/50 rounded-xl p-4 mb-6 space-y-3 text-left">
                            <div className="flex items-center gap-3">
                                <Icons.Mic size={18} className="text-green-500 shrink-0" />
                                <div>
                                    <div className="text-xs font-bold text-slate-700 dark:text-zinc-300 uppercase">Say "Next" / "Good"</div>
                                    <div className="text-[10px] text-slate-400">Mark as Good (+10 XP)</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <Icons.Mic size={18} className="text-orange-500 shrink-0" />
                                <div>
                                    <div className="text-xs font-bold text-slate-700 dark:text-zinc-300 uppercase">Say "Hard" / "Again"</div>
                                    <div className="text-[10px] text-slate-400">Mark as Hard + Repeat</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <Icons.Mic size={18} className="text-indigo-500 shrink-0" />
                                <div>
                                    <div className="text-xs font-bold text-slate-700 dark:text-zinc-300 uppercase">Say "Flip" / "Answer"</div>
                                    <div className="text-[10px] text-slate-400">Reveal the answer</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-zinc-800 transition-colors">Cancel</button>
                            <button onClick={onConfirm} className="flex-1 py-3.5 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-transform active:scale-95">Start Driving ðŸš—</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PlayView = ({ deck, bookmarks, onToggleBookmark, onFinish, onNav, history, showToast, addXp, onSrsReview, notes, onUpdateNote, useAIStudio, voiceName, srsSettings }) => {
            const [index, setIndex] = useState(() => parseInt(localStorage.getItem('ss_session_index')) || 0);

            useEffect(() => {
                localStorage.setItem('ss_session_index', index);
            }, [index]);
            const [isFlipped, setIsFlipped] = useState(false);
            const [localLearned, setLocalLearned] = useState([]);
            const [showConfetti, setShowConfetti] = useState(false);

            // Modes
            const [commuterMode, setCommuterMode] = useState(false);
            const [showCommuterGuide, setShowCommuterGuide] = useState(false);
            const [interviewMode, setInterviewMode] = useState(false);

            // Interview State
            const [timer, setTimer] = useState(120);
            const [isRecording, setIsRecording] = useState(false);
            const [audioUrl, setAudioUrl] = useState(null);
            const mediaRecorder = useRef(null);
            const audioChunks = useRef([]);
            const isProcessing = useRef(false);
            const handleSrsRef = useRef(null); // Ref for Voice Command Stability

            const card = deck[index] || {};

            // Load Recording on Index Change
            useEffect(() => {
                if (card.id) {
                    AudioDB.get(card.id).then(blob => {
                        if (blob) setAudioUrl(URL.createObjectURL(blob));
                        else setAudioUrl(null);
                    });
                }
            }, [card.id]);

            // Commuter State
            const synth = window.speechSynthesis;
            const uttr = useRef(new SpeechSynthesisUtterance());

            // Commuter Logic
            // Commuter Logic - Reactive (Reads current state, no auto-advance)
            useEffect(() => {
                if (!commuterMode || !card) {
                    synth.cancel();
                    return;
                }

                // Configure Voice
                if (voiceName) {
                    const voices = synth.getVoices();
                    const v = voices.find(vo => vo.name === voiceName);
                    if (v) uttr.current.voice = v;
                }

                // Determine Text based on state
                const text = isFlipped
                    ? `Answer. ${card.explanation}`
                    : `Question. ${card.title}. ${card.content}`;

                uttr.current.text = text;
                uttr.current.onend = null; // No auto-advance scripts

                // Speak (Debounce slightly to allow state settlement?)
                // Actually synth.cancel() handles it.
                synth.cancel();
                synth.speak(uttr.current);

                return () => synth.cancel();
            }, [commuterMode, index, isFlipped, voiceName]);

            // Interview Timer
            useEffect(() => {
                let interval;
                if (interviewMode && !isFlipped && timer > 0) {
                    interval = setInterval(() => {
                        setTimer(prev => {
                            if (prev <= 1) {
                                clearInterval(interval);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [interviewMode, isFlipped]);

            // Audio Recording - Split for explicit control
            const startRecording = async () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showToast("Mic not supported (Use localhost/HTTPS)");
                    console.error("navigator.mediaDevices not available");
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder.current = new MediaRecorder(stream);
                    audioChunks.current = [];

                    mediaRecorder.current.ondataavailable = (e) => audioChunks.current.push(e.data);
                    mediaRecorder.current.onstop = () => {
                        const blob = new Blob(audioChunks.current, { type: 'audio/webm' });
                        setAudioUrl(URL.createObjectURL(blob));
                        // Save to DB
                        AudioDB.save(card.id, blob).then(() => {
                            showToast("Recording Saved!");
                        });
                    };

                    mediaRecorder.current.start();
                    setIsRecording(true);
                    showToast("Recording Started");
                } catch (e) {
                    console.error("Mic Error:", e);
                    showToast("Mic Access Denied/Error");
                }
            };

            const stopRecording = () => {
                if (mediaRecorder.current && mediaRecorder.current.state !== 'inactive') {
                    mediaRecorder.current.stop();
                    setIsRecording(false);
                }
            };

            const toggleInterview = () => {
                const newMode = !interviewMode;
                setInterviewMode(newMode);
                setCommuterMode(false);

                if (newMode) {
                    setTimer(120);
                    startRecording();
                } else {
                    stopRecording();
                }
            };

            // Voice Commands moved below handleSrs to access latest closure via Ref

            const isLast = index === deck.length - 1;
            const hasLearned = history.includes(card?.id) || localLearned.includes(card?.id);

            // --- TOUCH / SWIPE LOGIC ---
            const [touchStart, setTouchStart] = useState(null); // {x, y}
            const [touchEnd, setTouchEnd] = useState(null);
            const [swipeOffset, setSwipeOffset] = useState(0);

            const minSwipeDistance = 100;

            const onTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart({ x: e.targetTouches[0].clientX, y: e.targetTouches[0].clientY });
            };

            const onTouchMove = (e) => {
                if (!touchStart) return;
                const currentX = e.targetTouches[0].clientX;
                const currentY = e.targetTouches[0].clientY;
                const dx = currentX - touchStart.x;
                const dy = currentY - touchStart.y;

                if (Math.abs(dy) > Math.abs(dx)) return; // Vertical scroll, ignore

                if (Math.abs(dx) > 10) {
                    setTouchEnd(currentX);
                    setSwipeOffset(dx);
                }
            };

            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) {
                    setSwipeOffset(0);
                    return;
                }
                const distance = touchStart.x - touchEnd; // Note: touchStart is obj
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;

                if (isLeftSwipe) {
                    handleSwipeAction('left');
                } else if (isRightSwipe) {
                    handleSwipeAction('right');
                } else {
                    setSwipeOffset(0);
                }
                setTouchStart(null);
                setTouchEnd(null);
            };

            const handleSwipeAction = (dir) => {
                if (dir === 'left') {
                    handleSrs(1);
                } else {
                    handleSrs(3);
                }
            };

            const handleSrs = (rating) => {
                if (isProcessing.current) return;
                isProcessing.current = true;

                if (onSrsReview) onSrsReview(card.id, rating);

                const dir = rating >= 2 ? 'right' : 'left';
                triggerAnim(dir === 'right' ? 'next' : 'prev');
                setCardAnim(dir === 'right' ? 'card-exit-right' : 'card-exit-left');

                addXp(rating >= 2 ? 10 : 2);
                showToast(rating >= 2 ? "Learned! +10 XP" : "Reviewing later");

                setTimeout(() => {
                    setIsFlipped(false);
                    setSwipeOffset(0);
                    if (isLast) finishSession();
                    else {
                        setIndex(index + 1);
                        setCardAnim('card-enter-bottom');
                        setTimeout(() => {
                            setCardAnim('');
                            isProcessing.current = false;
                        }, 200);
                    }
                    if (isLast) isProcessing.current = false;
                }, 200);
            };

            // Update Ref for Voice
            handleSrsRef.current = handleSrs;

            // Robust Voice Command Effect
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!commuterMode || !SpeechRecognition) return;

                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                // Track active state to manage restarts
                let isActive = true;

                recognition.onresult = (event) => {
                    const last = event.results.length - 1;
                    const result = event.results[last][0];
                    const command = result.transcript.trim().toLowerCase();
                    const confidence = result.confidence;

                    // Filter out noise/coughs (Adjusted Confidence Threshold)
                    if (confidence < 0.6) {
                        showToast(`ðŸŽ¤ Low conf: "${command}" (${(confidence * 100).toFixed(0)}%)`);
                        return;
                    }

                    // Tokenize
                    const words = command.split(/\s+/);

                    let matched = false;
                    // Commands
                    if (words.some(w => ['flip', 'answer', 'reveal', 'question', 'back'].includes(w))) {
                        setIsFlipped(prev => !prev);
                        showToast(`ðŸŽ¤ Flip ("${command}")`);
                        matched = true;
                    }
                    else if (words.some(w => ['next', 'good', 'pass', 'easy'].includes(w))) {
                        if (handleSrsRef.current) handleSrsRef.current(2);
                        showToast(`ðŸŽ¤ Next ("${command}")`);
                        matched = true;
                    }
                    else if (words.some(w => ['hard', 'again', 'difficult', 'bad'].includes(w))) {
                        if (handleSrsRef.current) handleSrsRef.current(1);
                        showToast(`ðŸŽ¤ Hard ("${command}")`);
                        matched = true;
                    }

                    if (!matched) {
                        showToast(`ðŸŽ¤ Ignored: "${command}"`);
                    }
                };



                recognition.onend = () => {
                    if (!isActive || !commuterMode) return;

                    // Protocol Check: Auto-restart only on HTTP/HTTPS to avoid file:// permission loops
                    const isWeb = window.location.protocol.startsWith('http');

                    if (isWeb) {
                        // console.log("Auto-restarting Mic...");
                        try { recognition.start(); } catch (e) { }
                    } else {
                        showToast("ðŸŽ¤ Mic timeout. Tap headset to resume.");
                        setCommuterMode(false);
                    }
                };

                recognition.onerror = (e) => {
                    if (e.error === 'not-allowed') {
                        isActive = false;
                        showToast("ðŸŽ¤ Mic Permission Denied");
                    } else if (e.error !== 'no-speech') {
                        // Show other errors: network, audio-capture, etc.
                        showToast(`ðŸŽ¤ Error: ${e.error}`);
                    }
                };

                try { recognition.start(); showToast("ðŸŽ¤ Listening..."); }
                catch (e) { console.error("Start Failed", e); }

                return () => {
                    isActive = false;
                    try { recognition.stop(); } catch (e) { }
                };
            }, [commuterMode]); // Stable! No index dependency means no constant restarting.

            useEffect(() => {
                const handleKey = (e) => {
                    if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
                    if (e.key === 'ArrowRight') handleSrs(3);
                    if (e.key === 'ArrowLeft') handleSrs(1);
                    if (e.key === ' ') {
                        e.preventDefault();
                        setIsFlipped(p => !p);
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [index, isFlipped]);

            const finishSession = () => {
                setShowConfetti(true);
                setTimeout(() => {
                    onFinish(localLearned, []);
                    onNav('home');
                }, 1000);
            };

            const [animState, setAnimState] = useState({ prev: false, next: false });
            const [cardAnim, setCardAnim] = useState('');

            const triggerAnim = (dir) => {
                setAnimState(prev => ({ ...prev, [dir]: true }));
                setTimeout(() => setAnimState(prev => ({ ...prev, [dir]: false })), 200);
            };

            const nextCard = () => {
                if (isProcessing.current) return;
                isProcessing.current = true;

                triggerAnim('next');
                addXp(10);
                showToast("+10 XP");
                setCardAnim('card-exit-left');
                setTimeout(() => {
                    setIsFlipped(false);
                    setSwipeOffset(false);
                    if (isLast) finishSession();
                    else {
                        setIndex(index + 1);
                        setCardAnim('card-enter-right');
                        setTimeout(() => {
                            setCardAnim('');
                            isProcessing.current = false;
                        }, 200);
                    }
                    if (isLast) isProcessing.current = false;
                }, 200);
            };

            const prevCard = () => {
                if (isProcessing.current) return;
                // No strict debounce needed for prev since no rating logic, but good for anim
                // Let's keep it simple for prev
                triggerAnim('prev');
                if (index > 0) {
                    setCardAnim('card-exit-right');
                    setTimeout(() => {
                        setIsFlipped(false);
                        setIndex(index - 1);
                        setCardAnim('card-enter-left');
                        setTimeout(() => setCardAnim(''), 200);
                    }, 200);
                }
            };

            const toggleLearned = (e) => {
                e.stopPropagation();
                if (localLearned.includes(card.id)) setLocalLearned(localLearned.filter(id => id !== card.id));
                else setLocalLearned([...localLearned, card.id]);
            };

            const copyPrompt = (e) => {
                e.stopPropagation();
                const prompt = `Topic: ${card.title} \n\nQuestion: \n${card.content} \n\nAnswer: \n${card.explanation} \n\nPlease explain this interview question and answer in detail and explain why it matters for a senior dev.`;
                navigator.clipboard.writeText(prompt);

                if (useAIStudio) {
                    const encoded = encodeURIComponent(prompt);
                    window.open(`https://aistudio.google.com/prompts/new_chat?prompt=${encoded}`, '_blank');
                    showToast("Opening AI Studio...");
                } else {
                    showToast("Prompt copied to clipboard!");
                }
            };

            if (!card) return null;

            // Rotation with swipe
            const swipeRotation = swipeOffset / 20; // 200px -> 10deg
            const swipeOpacity = Math.max(0, 1 - Math.abs(swipeOffset) / 500);
            const style = {
                transform: `translateX(${swipeOffset}px) rotate(${swipeRotation}deg) ${isFlipped ? 'rotateY(180deg)' : ''}`,
                opacity: isFlipped ? 1 : Math.min(1, Math.max(0.5, 1 - Math.abs(swipeOffset) / 1000)),
                touchAction: 'pan-y' // ALLOW SCROLLING
            };

            return (
                <div className="h-screen bg-slate-100 dark:bg-zinc-950 flex flex-col relative overflow-hidden">
                    {showConfetti && <SimpleConfetti />}
                    {/* Header */}
                    <div className="p-4 flex justify-between items-center z-10">
                        <button onClick={() => onNav('home')} className="text-slate-400 p-2"><Icons.X /></button>
                        <div className="text-xs font-bold text-slate-400 bg-white dark:bg-zinc-900 px-3 py-1 rounded-full shadow-sm">
                            {interviewMode ? <span className={`text-${timer < 30 ? 'red' : 'indigo'}-500`}>{Math.floor(timer / 60)}:{(timer % 60).toString().padStart(2, '0')}</span> : `${index + 1} / ${deck.length}`}
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => {
                                if (commuterMode) setCommuterMode(false);
                                else { setInterviewMode(false); setShowCommuterGuide(true); }
                            }} className={`p-2 rounded-full ${commuterMode ? 'bg-indigo-600 text-white' : 'text-slate-300 dark:text-zinc-600'}`}><Icons.Headphones size={20} /></button>
                            <button onClick={toggleInterview} className={`p-2 rounded-full ${interviewMode ? 'bg-red-500 text-white animate-pulse' : 'text-slate-300 dark:text-zinc-600'}`}><Icons.Mic size={20} /></button>
                            <button onClick={() => onToggleBookmark(card.id)} className={bookmarks.includes(card.id) ? "text-yellow-400 p-2" : "text-slate-300 dark:text-zinc-600 p-2"}><Icons.Bookmark fill={bookmarks.includes(card.id) ? "currentColor" : "none"} /></button>
                        </div>
                    </div>

                    {/* Card Container - CENTERED but Scrollable (Safe Centering with my-auto) */}
                    <div className="flex-1 flex flex-col items-center pt-4 pb-20 overflow-y-auto overflow-x-hidden no-scrollbar">
                        <div
                            className={`relative w-full max-w-sm transition-transform duration-75 cursor-pointer my-auto ${cardAnim}`}
                            style={cardAnim ? {} : style}
                            onClick={() => setIsFlipped(!isFlipped)}
                            onTouchStart={onTouchStart}
                            onTouchMove={onTouchMove}
                            onTouchEnd={onTouchEnd}
                        >
                            {!isFlipped ? (
                                /* FRONT */
                                <div className="bg-white dark:bg-zinc-900 rounded-3xl shadow-xl border border-slate-200 dark:border-zinc-800 flex flex-col min-h-[50vh] overflow-hidden relative">
                                    {/* Swipe Overlays */}
                                    <div className="absolute top-8 right-8 z-20 pointer-events-none" style={{ opacity: Math.max(0, -swipeOffset / 100) }}>
                                        <div className="border-4 border-red-500 rounded-xl px-4 py-2 text-red-500 font-black text-2xl tracking-widest uppercase -rotate-12 bg-white/10 backdrop-blur-sm">Again</div>
                                    </div>
                                    <div className="absolute top-8 left-8 z-20 pointer-events-none" style={{ opacity: Math.max(0, swipeOffset / 100) }}>
                                        <div className="border-4 border-green-500 rounded-xl px-4 py-2 text-green-500 font-black text-2xl tracking-widest uppercase rotate-12 bg-white/10 backdrop-blur-sm">Good</div>
                                    </div>
                                    <div className="bg-slate-50 dark:bg-zinc-800/50 p-6 border-b border-slate-100 dark:border-zinc-800 text-center select-none">
                                        <span className="text-[10px] px-2 py-1 rounded-full font-bold tracking-wider uppercase bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300 mr-2">{card.category}</span>
                                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold tracking-wider uppercase ${card.difficulty === 'Senior' ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300' : card.difficulty === 'Principal' ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300' : 'bg-green-100 text-green-600'}`}>{card.difficulty || 'General'}</span>
                                        <h3 className="text-xl font-bold text-slate-800 dark:text-white mt-3">{card.title}</h3>
                                    </div>
                                    <div className="flex-1 p-8">
                                        <div className="w-full text-base text-slate-700 dark:text-zinc-300 leading-relaxed font-medium"><Markdown content={card.content} /></div>
                                    </div>
                                    <div className="p-4 text-center text-xs text-slate-300 dark:text-zinc-600 font-bold uppercase tracking-widest animate-pulse border-t border-slate-100 dark:border-zinc-800">
                                        Tap to Reveal Answer
                                    </div>
                                </div>
                            ) : (
                                /* BACK */
                                <div className="bg-indigo-50 dark:bg-zinc-900 rounded-3xl shadow-xl border-2 border-indigo-100 dark:border-indigo-900/50 flex flex-col min-h-[50vh] overflow-hidden" style={{ transform: 'rotateY(180deg)' }}>
                                    <div className="bg-indigo-100 dark:bg-indigo-900/20 p-4 border-b border-indigo-200 dark:border-indigo-900/50 flex justify-between items-center">
                                        <h3 className="text-sm font-bold text-indigo-800 dark:text-indigo-300 uppercase tracking-widest">Explanation</h3>
                                    </div>
                                    <div className="flex-1 p-8 bg-white dark:bg-zinc-900/50">
                                        <div className="text-base text-slate-700 dark:text-zinc-300 leading-relaxed whitespace-pre-wrap"><Markdown content={card.explanation} /></div>
                                    </div>

                                    {/* AUDIO PLAYBACK */}
                                    {audioUrl && (
                                        <div className="mt-4 pt-2 border-t border-slate-100 dark:border-zinc-800" onClick={e => e.stopPropagation()}>
                                            <div className="text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-2 px-2">Voice Note</div>
                                            <div className="p-2 flex justify-center bg-zinc-100 dark:bg-zinc-800 rounded-xl mx-2">
                                                <audio controls src={audioUrl} className="w-full h-8" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="p-2 flex justify-center gap-4 bg-indigo-50 dark:bg-indigo-900/10 border-t border-indigo-100 dark:border-zinc-800">
                                        <button onClick={copyPrompt} className="p-2 text-indigo-400 hover:text-indigo-600 flex items-center gap-2 text-xs font-bold uppercase tracking-wide"><Icons.Robot size={18} /> Ask AI</button>
                                    </div>

                                    <div className="p-4 border-t border-slate-100 dark:border-zinc-800 bg-slate-50 dark:bg-zinc-900/50">
                                        <textarea
                                            className="w-full bg-transparent text-xs text-slate-600 dark:text-zinc-400 placeholder-slate-300 dark:placeholder-zinc-600 resize-none focus:outline-none"
                                            placeholder="Add personal notes here..."
                                            rows={3}
                                            value={notes[card.id] || ''}
                                            onChange={(e) => onUpdateNote(card.id, e.target.value)}
                                            onClick={e => e.stopPropagation()}
                                        />
                                    </div>

                                    {/* SRS Actions */}
                                    <div className="grid grid-cols-4 gap-1 p-2 bg-white dark:bg-zinc-900 border-t border-slate-100 dark:border-zinc-800">
                                        <button onClick={(e) => { e.stopPropagation(); handleSrs(0); }} className="flex flex-col items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-zinc-800">
                                            <span className="text-[10px] font-bold text-red-500 uppercase">Again</span>
                                            <span className="text-[9px] text-slate-400">1m</span>
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); handleSrs(1); }} className="flex flex-col items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-zinc-800">
                                            <span className="text-[10px] font-bold text-orange-500 uppercase">Hard</span>
                                            <span className="text-[9px] text-slate-400">{srsSettings.hard?.val ?? 0.5}{srsSettings.hard?.unit ?? 'd'}</span>
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); handleSrs(2); }} className="flex flex-col items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-zinc-800">
                                            <span className="text-[10px] font-bold text-green-500 uppercase">Good</span>
                                            <span className="text-[9px] text-slate-400">{srsSettings.good?.val ?? 1}{srsSettings.good?.unit ?? 'd'}</span>
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); handleSrs(3); }} className="flex flex-col items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-zinc-800">
                                            <span className="text-[10px] font-bold text-blue-500 uppercase">Easy</span>
                                            <span className="text-[9px] text-slate-400">{srsSettings.easy?.val ?? 4}{srsSettings.easy?.unit ?? 'd'}</span>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Action Buttons (Footer) */}
                        <div className="p-6 pb-12 flex justify-center gap-8 z-10">
                            <button onClick={(e) => { e.stopPropagation(); handleSrs(1); }} className="w-16 h-16 bg-white dark:bg-zinc-800 rounded-full shadow-xl shadow-red-500/10 text-red-500 flex items-center justify-center hover:scale-105 active:scale-95 transition-all border border-slate-100 dark:border-zinc-700">
                                <Icons.X size={32} strokeWidth={3} />
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); setIsFlipped(!isFlipped); }} className="w-12 h-12 bg-white dark:bg-zinc-800 rounded-full shadow-lg text-indigo-500 flex items-center justify-center hover:scale-105 active:scale-95 transition-all border border-slate-100 dark:border-zinc-700">
                                <Icons.RotateCcw size={20} strokeWidth={2.5} />
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); handleSrs(2); }} className="w-16 h-16 bg-white dark:bg-zinc-800 rounded-full shadow-xl shadow-green-500/10 text-green-500 flex items-center justify-center hover:scale-105 active:scale-95 transition-all border border-slate-100 dark:border-zinc-700">
                                <Icons.Check size={32} strokeWidth={3} />
                            </button>
                        </div>
                    </div>

                    {/* Modals */}
                    <CommuterGuideModal
                        isOpen={showCommuterGuide}
                        onClose={() => setShowCommuterGuide(false)}
                        onConfirm={() => { setShowCommuterGuide(false); setCommuterMode(true); }}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>